const Module=require("module"),originalRequire=Module.prototype.require;Module.prototype.require=function(e){try{return originalRequire.apply(this,arguments)}catch(s){if("MODULE_NOT_FOUND"===s.code&&process.env.ELECTRON_RUN_AS_NODE){console.log(`Module not found: ${e}, attempting alternative resolution...`);const s=[path.join(__dirname,"node_modules",e),path.join(process.cwd(),"node_modules",e),path.join(__dirname,"..","node_modules",e)];for(const o of s)try{return originalRequire.call(this,o)}catch(e){}}throw s}};const express=require("express"),cors=require("cors"),{createServer:createServer}=require("http"),{Server:Server}=require("socket.io"),{spawn:spawn}=require("child_process"),path=require("path"),os=require("os"),fs=require("fs"),app=express(),httpServer=createServer(app),io=new Server(httpServer,{cors:{origin:"*",methods:["GET","POST"]}});app.use(cors()),app.use(express.json()),app.get("/health",(e,s)=>{s.json({status:"ok",service:"yurucode-claude"})});const SessionState={IDLE:"idle",PROCESSING:"processing",STREAMING:"streaming",INTERRUPTED:"interrupted",ERROR:"error"};let sessions=new Map,activeProcesses=new Map,lastAssistantMessageIds=new Map,sessionStates=new Map,sessionRetryCount=new Map;"win32"!==process.platform&&(process.on("exit",()=>{for(const[e,s]of activeProcesses)try{process.kill(-s.pid,"SIGTERM")}catch(e){}}),["SIGINT","SIGTERM"].forEach(e=>{process.on(e,()=>{console.log(`\nüõë Received ${e}, cleaning up...`);for(const[e,s]of activeProcesses)try{process.kill(-s.pid,"SIGTERM")}catch(e){}process.exit(0)})}));let sessionIdCounter=0;const MAX_MESSAGE_HISTORY=1e3,MAX_LINE_BUFFER_SIZE=10485760;let lastGcTime=Date.now();const GC_INTERVAL=3e5;async function generateTitle(e,s,o){try{console.log(`üè∑Ô∏è Generating title for session ${e}`),console.log(`üè∑Ô∏è Message preview: "${s.substring(0,100)}..."`);const t=["--output-format","json","--model","claude-sonnet-4-5-20250929","--print"],n=`user message: "${s.substring(0,200)}"\ntask: reply with ONLY 1-3 words describing what user wants. lowercase only. no punctuation. be extremely concise. examples: "echo command", "file search", "debug issue"`;let l;if(console.log(`üè∑Ô∏è Title prompt: "${n}"`),"win32"===process.platform){const e=n.replace(/"/g,'\\"').replace(/\n/g,"\\n"),s=t.map(e=>e.includes(" ")||e.includes("\n")||e.includes('"')||e.includes("'")?"'"+e.replace(/'/g,"'\\''")+"'":e).join(" "),o=["command -v claude &> /dev/null && claude","[ -x /usr/local/bin/claude ] && /usr/local/bin/claude","[ -x /usr/bin/claude ] && /usr/bin/claude","[ -x ~/.local/bin/claude ] && ~/.local/bin/claude","[ -x ~/.npm-global/bin/claude ] && ~/.npm-global/bin/claude","[ -x ~/node_modules/.bin/claude ] && ~/node_modules/.bin/claude","[ -x ~/.claude/local/claude ] && ~/.claude/local/claude",'for u in /home/*; do [ -x "$u/.npm-global/bin/claude" ] && { "$u/.npm-global/bin/claude" "$@"; exit $?; }; done; false','for u in /home/*; do [ -x "$u/node_modules/.bin/claude" ] && { "$u/node_modules/.bin/claude" "$@"; exit $?; }; done; false','for n in ~/.nvm/versions/node/*/bin/claude; do [ -x "$n" ] && { "$n" "$@"; exit $?; }; done; false',"[ -x /opt/claude/bin/claude ] && /opt/claude/bin/claude"].map(e=>`(${e} ${s})`).join(" || ");l=spawn("wsl.exe",["-e","bash","-c",`echo "${e}" | (${o} || (echo "Claude CLI not found in WSL. Searched all common paths including npm global installations." >&2 && exit 127))`],{cwd:process.cwd(),env:{...process.env},stdio:["inherit","pipe","pipe"]})}else l=spawn("claude",t,{cwd:process.cwd(),env:{...process.env},stdio:["pipe","pipe","pipe"]});let i="",r="";l.stdout.on("data",e=>{i+=e.toString(),console.log(`üè∑Ô∏è Title generation stdout: ${e.toString()}`)}),l.stderr.on("data",e=>{r+=e.toString(),console.log(`üè∑Ô∏è Title generation stderr: ${e.toString()}`)}),l.on("close",s=>{console.log(`üè∑Ô∏è Title generation process closed with code ${s}`),console.log(`üè∑Ô∏è Full output: "${i}"`),r&&console.log(`üè∑Ô∏è Error output: "${r}"`);try{const s=i.trim().split("\n"),t=s[s.length-1];console.log(`üè∑Ô∏è Parsing last line: "${t}"`);const n=JSON.parse(t),l=n.completion||n.result;if(l){let s=l.toLowerCase().replace(/[^\w\s]/g,"").trim().substring(0,30);if(s&&s.length>2){console.log(`üè∑Ô∏è Generated title: "${s}" - emitting to client`);const t=`title:${e}`;console.log(`üè∑Ô∏è Emitting event: ${t} with data:`,{title:s}),o.emit(t,{title:s})}else console.log(`üè∑Ô∏è Title too short or empty: "${s}"`)}else console.log("üè∑Ô∏è No title text in response:",n)}catch(e){console.error("üè∑Ô∏è Failed to parse title response:",e),console.error("üè∑Ô∏è Raw output was:",i)}}),l.on("error",e=>{console.error("üè∑Ô∏è Failed to spawn title generation process:",e)}),"win32"!==process.platform&&(console.log("üè∑Ô∏è Writing prompt to stdin"),l.stdin.write(n),l.stdin.end())}catch(e){console.error("üè∑Ô∏è Failed to generate title:",e)}}io.on("connection",e=>{console.log("‚ú® ===== NEW CLIENT CONNECTION ====="),console.log("Client ID:",e.id),console.log("Client address:",e.handshake.address),console.log("Transport:",e.conn.transport.name),console.log("Time:",(new Date).toISOString()),console.log("==================================="),e.on("createSession",async(s,o)=>{try{const t=`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;console.log(`‚ú® Creating new session: ${t}`);const n=s.workingDirectory||process.cwd(),l={id:t,name:s.name||"new session",socketId:e.id,workingDirectory:n,messages:[],createdAt:Date.now(),claudeSessionId:null,lastActivity:Date.now(),messageCount:0,errorCount:0,hasGeneratedTitle:!1};sessions.set(t,l),sessionStates.set(t,SessionState.IDLE),sessionRetryCount.set(t,0),console.log(`‚úÖ Session ready: ${t}`),console.log(`üìÅ Working directory: ${n}`),o({success:!0,sessionId:t,messages:[],workingDirectory:n})}catch(e){console.error("Error creating session:",e),o({success:!1,error:e.message})}}),e.on("sendMessage",async(s,o)=>{try{const{sessionId:t,content:n,model:l}=s,i=sessions.get(t);if(!i)throw new Error(`Session ${t} not found`);const r=sessionStates.get(t);if(r===SessionState.PROCESSING||r===SessionState.STREAMING)return console.warn(`‚ö†Ô∏è Session ${t} is already processing (state: ${r})`),void o({success:!1,error:"Session is already processing a message"});if(sessionStates.set(t,SessionState.PROCESSING),i.lastActivity=Date.now(),i.messageCount++,console.log(`üìù Message #${i.messageCount} for session ${t}: ${n.substring(0,50)}...`),console.log(`üè∑Ô∏è Title check: hasGeneratedTitle=${i.hasGeneratedTitle}, contentLength=${n?.length}`),!i.hasGeneratedTitle&&n&&n.length>5){let s=n;try{const e=JSON.parse(n);Array.isArray(e)&&(s=e.filter(e=>"text"===e.type).map(e=>e.text).join(" "),console.log(`üè∑Ô∏è Extracted text from JSON: "${s.substring(0,50)}..."`))}catch(e){console.log(`üè∑Ô∏è Using plain text content: "${s.substring(0,50)}..."`)}s&&s.trim().length>5?(console.log(`üè∑Ô∏è Calling generateTitle for session ${t}`),generateTitle(t,s,e),i.hasGeneratedTitle=!0):console.log(`üè∑Ô∏è Skipping title generation - text too short: "${s}"`)}const a={id:`user-${Date.now()}`,type:"user",message:{content:n},timestamp:Date.now()};i.messages.push(a);let c=i.workingDirectory;if("linux"===process.platform&&c.match(/^[A-Z]:\\/)){const e=c[0].toLowerCase(),s=c.substring(2).replace(/\\/g,"/");c=`/mnt/${e}${s}`}let d=null;if("win32"===process.platform)d="claude",console.log("ü™ü Windows detected - will use WSL to run claude");else{const s=os.homedir(),n=[path.join(s,".claude","local","claude"),path.join(s,".local","bin","claude"),"claude"],l=require("fs");for(const e of n)if(l.existsSync(e)){d=e,console.log(`üîß Found claude at: ${e}`);break}if(!d)return e.emit(`message:${t}`,{type:"system",subtype:"error",message:"Claude CLI not found. Please ensure claude is installed. Check paths: "+n.join(", "),timestamp:Date.now()}),void o({success:!1,error:"Claude CLI not found"})}const u=["--print","--output-format","stream-json","--verbose","--dangerously-skip-permissions"],g="CRITICAL: you are in yurucode ui. ALWAYS:\n- use all lowercase (no capitals ever)\n- be extremely concise\n- never use formal language  \n- no greetings/pleasantries\n- straight to the point\n- code/variables keep proper case\n- one line answers preferred";let p;u.push("--append-system-prompt",g),l&&(u.push("--model",l),console.log(`ü§ñ Using model: ${l}`)),i.claudeSessionId?(u.push("--resume",i.claudeSessionId),console.log(`üìå Resuming Claude session: ${i.claudeSessionId}`),console.log("‚ö†Ô∏è RESUMING WILL INCLUDE ALL PREVIOUS TOKENS FROM THIS CLAUDE SESSION!")):(console.log("üÜï Starting new Claude session"),console.log("‚ú® This should start with ~0 tokens (only system prompt)")),console.log("üöÄ Running claude with args:",u.join(" "));try{if("win32"===process.platform){console.log("ü™ü Windows detected - running claude through WSL"),console.log("Working directory:",i.workingDirectory),console.log("Working directory (WSL format):",c);const e=u.map(e=>e.includes(" ")||e.includes("\n")||e.includes('"')||e.includes("'")?"'"+e.replace(/'/g,"'\\''")+"'":e).join(" "),s=["-e","bash","-c",`cd '${c}' && (${["command -v claude &> /dev/null && claude","[ -x /usr/local/bin/claude ] && /usr/local/bin/claude","[ -x /usr/bin/claude ] && /usr/bin/claude","[ -x ~/.local/bin/claude ] && ~/.local/bin/claude","[ -x ~/.npm-global/bin/claude ] && ~/.npm-global/bin/claude","[ -x ~/node_modules/.bin/claude ] && ~/node_modules/.bin/claude","[ -x ~/.claude/local/claude ] && ~/.claude/local/claude",'for u in /home/*; do [ -x "$u/.npm-global/bin/claude" ] && { "$u/.npm-global/bin/claude" "$@"; exit $?; }; done; false','for u in /home/*; do [ -x "$u/node_modules/.bin/claude" ] && { "$u/node_modules/.bin/claude" "$@"; exit $?; }; done; false','for n in ~/.nvm/versions/node/*/bin/claude; do [ -x "$n" ] && { "$n" "$@"; exit $?; }; done; false',"[ -x /opt/claude/bin/claude ] && /opt/claude/bin/claude"].map(s=>`(${s} ${e})`).join(" || ")} || (echo "Claude CLI not found in WSL. Searched all common paths including npm global installations. Install with: npm install -g @anthropic-ai/claude-cli" >&2 && exit 127))`];if(console.log("WSL command:","wsl.exe",s.join(" ")),console.log("Full args array:",s),p=spawn("wsl.exe",s,{cwd:i.workingDirectory,env:process.env,stdio:["pipe","pipe","pipe"],shell:!1,windowsHide:!0}),!p||!p.pid)throw new Error("Failed to spawn WSL process")}else p=spawn(d,u,{cwd:c,env:{...process.env},stdio:["pipe","pipe","pipe"],detached:"win32"!==process.platform,shell:!1,windowsHide:!0}),"win32"!==process.platform&&p.unref()}catch(s){return console.error("Failed to spawn claude process:",s),e.emit(`message:${t}`,{type:"system",subtype:"error",message:`Failed to start Claude: ${s.message}. ${"win32"===process.platform?"Make sure WSL is installed and Claude CLI is installed in WSL.":`Path: ${d}`}`,timestamp:Date.now()}),void o({success:!1,error:`Failed to spawn: ${s.message}`})}activeProcesses.set(t,p),e.emit(`message:${t}`,{type:"system",subtype:"info",message:`Starting Claude${"win32"===process.platform?" via WSL":""}...`,timestamp:Date.now()}),console.log(`Process spawned with PID: ${p.pid}`);let m="",S=0;const $=s=>{if(s.trim())try{const o=JSON.parse(s);if(console.log(`üì¶ Message type: ${o.type}${o.subtype?` (${o.subtype})`:""}`),"assistant"===o.type&&o.message?.content)for(const e of o.message.content)"text"===e.type?console.log(`   üí¨ Assistant text: "${e.text.substring(0,100)}${e.text.length>100?"...":""}"`):"tool_use"===e.type&&console.log(`   üîß Tool use: ${e.name} (id: ${e.id})`);else if("user"===o.type&&o.message?.content){for(const e of o.message.content)if("tool_result"===e.type){const s="string"==typeof e.content?e.content.substring(0,50):JSON.stringify(e.content).substring(0,50);console.log(`   üìä Tool result for ${e.tool_use_id}: ${s}...`)}}else"result"===o.type&&console.log(`   ‚úÖ Result: success=${!o.is_error}, duration=${o.duration_ms}ms`);if("system"===o.type&&"init"===o.subtype)console.log(`üìå System init - NEW Claude session will be: ${o.session_id}`),e.emit(`message:${t}`,{type:"system",subtype:"init",message:o,timestamp:Date.now()});else if("assistant"===o.type){const s=`assistant-${t}-${Date.now()}-${Math.random()}`;if(o.message?.content){let n=!1,l="";for(const s of o.message.content)"text"===s.type?(n=!0,l=s.text):"tool_use"===s.type&&e.emit(`message:${t}`,{type:"tool_use",message:{name:s.name,input:s.input,id:s.id},timestamp:Date.now(),id:`tool-${t}-${Date.now()}`});if(n&&l){if(lastAssistantMessageIds.set(t,s),sessionStates.set(t,SessionState.STREAMING),e.emit(`message:${t}`,{type:"assistant",message:{content:l},streaming:!0,id:s,timestamp:Date.now()}),i.messages.push({type:"assistant",message:{content:l},id:s,timestamp:Date.now()}),i.messages.length>1e3){const e=Math.floor(200);i.messages.splice(0,e),console.log(`üßπ Trimmed ${e} old messages from session ${t}`)}S++}else!n&&o.message?.content&&console.log("Assistant message with only tool uses, skipping text message")}}else if("user"===o.type&&o.message?.content)for(const s of o.message.content)"tool_result"===s.type&&e.emit(`message:${t}`,{type:"tool_result",message:{tool_use_id:s.tool_use_id,content:s.content,is_error:s.is_error},timestamp:Date.now(),id:`toolresult-${t}-${Date.now()}`});else if("result"===o.type){console.log(`üì¶ Message type: result (${o.result})`),console.log(`   ‚úÖ Result: success=${"success"===o.result}, duration=${o.duration}ms`),o.session_id&&"success"===o.result&&(i.claudeSessionId=o.session_id,console.log(`üìå Saved Claude session ID for resume: ${i.claudeSessionId}`)),sessionStates.set(t,SessionState.IDLE),sessionRetryCount.set(t,0),console.log("\nüö®üö®üö® TOKEN DEBUG - CLAUDE CLI RESULT üö®üö®üö®"),console.log(`Session ID: ${i.claudeSessionId}`),console.log("Is this a NEW session? "+(i.claudeSessionId?"NO - RESUMING":"YES - FRESH START"));const s=o.usage&&0===o.usage.input_tokens&&0===o.usage.output_tokens&&0===o.usage.cache_creation_input_tokens&&0===o.usage.cache_read_input_tokens;if(s&&(console.log("\nüóúÔ∏èüóúÔ∏èüóúÔ∏è COMPACT DETECTED - ALL TOKENS ARE ZERO üóúÔ∏èüóúÔ∏èüóúÔ∏è"),console.log("This indicates a /compact command was executed"),console.log("The next user message should show reduced token counts")),o.usage){console.log("\nüìä EXACT TOKEN USAGE FROM CLAUDE CLI:"),console.log(`   input_tokens: ${o.usage.input_tokens||0}`),console.log(`   output_tokens: ${o.usage.output_tokens||0}`),console.log(`   cache_creation_input_tokens: ${o.usage.cache_creation_input_tokens||0}`),console.log(`   cache_read_input_tokens: ${o.usage.cache_read_input_tokens||0}`);const e=(o.usage.input_tokens||0)+(o.usage.cache_creation_input_tokens||0)+(o.usage.cache_read_input_tokens||0),t=o.usage.output_tokens||0;console.log(`   TOTAL INPUT: ${e}`),console.log(`   TOTAL OUTPUT: ${t}`),console.log(`   GRAND TOTAL: ${e+t}`),console.log("   IS COMPACT: "+(s?"YES - CONTEXT COMPACTED":"NO"))}else console.log("   ‚ö†Ô∏è NO USAGE DATA IN RESULT");o.cost&&(console.log("\nüíµ COST FROM CLAUDE:"),console.log(`   Total: $${o.total_cost_usd||0}`)),console.log("üö®üö®üö® END TOKEN DEBUG üö®üö®üö®\n");const n=lastAssistantMessageIds.get(t);n&&(e.emit(`message:${t}`,{type:"assistant",id:n,streaming:!1,timestamp:Date.now()}),lastAssistantMessageIds.delete(t)),e.emit(`message:${t}`,{type:"result",...o,streaming:!1,id:`result-${t}-${Date.now()}`,model:l})}}catch(e){console.log("Plain text output:",s)}};if(p.stdout.on("data",s=>{const o=s.toString();if(console.log("STDOUT received:",o.length,"bytes"),m.length>10485760)return console.error("‚ö†Ô∏è Line buffer overflow - clearing buffer"),m="",void e.emit(`message:${t}`,{type:"system",subtype:"warning",message:"Stream buffer overflow - some output may be lost",timestamp:Date.now()});m+=o;const n=m.split("\n");m=n.pop()||"";for(const e of n)$(e)}),p.stderr.on("data",s=>{const o=s.toString();if(console.error("Claude stderr:",o),o.includes("No conversation found with session ID")){const s=sessions.get(t);s&&(s.claudeSessionId=void 0,sessionRetryCount.set(t,0),sessionStates.set(t,SessionState.IDLE),console.log(`üîÑ Cleared invalid Claude session ID for ${t}`));const o=lastAssistantMessageIds.get(t);o&&(e.emit(`message:${t}`,{type:"assistant",id:o,streaming:!1,timestamp:Date.now()}),lastAssistantMessageIds.delete(t)),e.emit(`message:${t}`,{type:"system",subtype:"info",message:"starting fresh conversation...",timestamp:Date.now()}),e.emit(`message:${t}`,{type:"result",id:`${t}-session-reset-${Date.now()}`,sessionId:t,streaming:!1,timestamp:Date.now()})}else e.emit(`message:${t}`,{type:"system",subtype:"error",message:o,timestamp:Date.now()}),e.emit(`message:${t}`,{type:"result",id:`${t}-error-${Date.now()}`,sessionId:t,streaming:!1,timestamp:Date.now()}),sessionStates.set(t,SessionState.IDLE)}),n){const s=n.endsWith("\n")?n:n+"\n";console.log("\nüîç SENDING PROMPT TO CLAUDE:"),console.log(`   Length: ${s.length} characters`),console.log(`   Content: "${s.substring(0,500)}${s.length>500?"...":""}"`),console.log(`   Estimated tokens (rough): ~${Math.ceil(s.length/4)}`),p.stdin.write(s,"utf8",s=>{s?(console.error("Error writing to stdin:",s),e.emit(`message:${t}`,{type:"system",subtype:"error",message:`Failed to send prompt: ${s.message}`,timestamp:Date.now()})):console.log("‚úÖ Prompt sent to Claude via stdin"),p.stdin.end()})}else p.stdin.end();p.on("close",s=>{console.log(`Claude process exited with code ${s}`),console.log(`Total messages processed: ${S}`),sessionStates.get(t)!==SessionState.INTERRUPTED&&(0===s||null===s?sessionStates.set(t,SessionState.IDLE):sessionStates.set(t,SessionState.ERROR)),m.trim()&&$(m),m="";const o=Date.now();o-lastGcTime>3e5&&global.gc&&(console.log("üßπ Running garbage collection"),global.gc(),lastGcTime=o);const n=lastAssistantMessageIds.get(t);if(n&&(e.emit(`message:${t}`,{type:"assistant",id:n,streaming:!1,timestamp:Date.now()}),lastAssistantMessageIds.delete(t)),0!==s&&null!==s){console.error(`Claude process failed with exit code ${s}`);const o=sessions.get(t);if(o&&1===s){const e=sessionRetryCount.get(t)||0;e>=2?(o.claudeSessionId=void 0,console.log(`üîÑ Cleared Claude session ID for ${t} after ${e} failures`),sessionRetryCount.set(t,0)):(sessionRetryCount.set(t,e+1),console.log(`‚ö†Ô∏è Session ${t} failed, retry count: ${e+1}/2`))}e.emit(`message:${t}`,{type:"system",subtype:"error",message:"Process failed. Starting fresh session for next message.",timestamp:Date.now()})}activeProcesses.delete(t)}),p.on("error",s=>{console.error("Failed to spawn claude:",s),m="";let o=`Failed to run Claude: ${s.message}`;"ENOENT"===s.code?o="win32"===process.platform?"WSL not found. Please install Windows Subsystem for Linux and ensure Claude CLI is installed in WSL.":"Claude CLI not found. Please install Claude CLI and ensure it's in your PATH.":"EACCES"===s.code&&(o="Permission denied. Check that Claude CLI has execute permissions.");const n=lastAssistantMessageIds.get(t);n&&(e.emit(`message:${t}`,{type:"assistant",id:n,streaming:!1,timestamp:Date.now()}),lastAssistantMessageIds.delete(t));const l=sessions.get(t);l&&(l.claudeSessionId=void 0,console.log(`üîÑ Cleared Claude session ID for ${t} due to spawn error`)),e.emit(`message:${t}`,{type:"system",subtype:"error",message:o,timestamp:Date.now()}),activeProcesses.delete(t)}),o({success:!0})}catch(e){console.error("Error in sendMessage:",e),o({success:!1,error:e.message})}}),e.on("interrupt",(s,o)=>{const t=s?.sessionId||s;console.log(`‚õî Interrupt requested for session ${t}`);const n=sessionStates.get(t);console.log(`  Current state: ${n||"unknown"}`),sessionStates.set(t,SessionState.INTERRUPTED);const l=activeProcesses.get(t);if(l){if(console.log(`üõë Killing claude process for session ${t} (PID: ${l.pid})`),"win32"!==process.platform)try{process.kill(-l.pid,"SIGINT")}catch(e){l.kill("SIGINT")}else l.kill("SIGINT");activeProcesses.delete(t);const s=lastAssistantMessageIds.get(t);s&&(e.emit(`message:${t}`,{type:"assistant",id:s,streaming:!1,timestamp:Date.now()}),lastAssistantMessageIds.delete(t)),sessions.get(t),e.emit(`message:${t}`,{type:"system",subtype:"interrupted",message:"task interrupted by user",timestamp:Date.now()}),e.emit(`message:${t}`,{type:"result",id:`${t}-interrupted-${Date.now()}`,sessionId:t,streaming:!1,interrupted:!0,timestamp:Date.now()}),o&&o({success:!0,interrupted:!0})}else console.log(`‚ö†Ô∏è No active process found for session ${t}`),o&&o({success:!1,error:"No active process for this session"})}),e.on("clearSession",async(s,o)=>{const{sessionId:t}=s,n=sessions.get(t);if(n){console.log(`üßπ Clearing session ${t}`);const s=activeProcesses.get(t);if(s){if(console.log(`üõë Killing active process for session ${t}`),"win32"!==process.platform)try{process.kill(-s.pid,"SIGINT")}catch(e){s.kill("SIGINT")}else s.kill("SIGINT");activeProcesses.delete(t)}n.messages=[],n.claudeSessionId=null,lastAssistantMessageIds.delete(t),console.log(`‚úÖ Session ${t} cleared - will start fresh Claude session on next message`),e.emit(`message:${t}`,{type:"system",subtype:"clear",message:"session cleared",timestamp:Date.now()}),o({success:!0,cleared:!0})}else o({success:!1,error:"Session not found"})}),e.on("listSessions",async e=>{e({success:!0,sessions:Array.from(sessions.values()).map(e=>({id:e.id,name:e.name,workingDirectory:e.workingDirectory,createdAt:e.createdAt,messageCount:e.messages.length}))})}),e.on("deleteSession",async(e,s)=>{const{sessionId:o}=e;sessions.delete(o),lastAssistantMessageIds.delete(o),s({success:!0})}),e.on("setWorkingDirectory",async(e,s)=>{const{sessionId:o,directory:t}=e,n=sessions.get(o);n?(n.workingDirectory=t,console.log(`üìÅ Updated directory for ${o}: ${t}`),s({success:!0})):s({success:!1,error:"Session not found"})}),e.on("disconnect",s=>{console.log("üëã ===== CLIENT DISCONNECTED ====="),console.log("Client ID:",e.id),console.log("Reason:",s),console.log("Time:",(new Date).toISOString()),console.log("==================================")})});const PORT=process.env.PORT||3001,PID_FILE=path.join(__dirname,".server.pid");function writePidFile(){try{fs.writeFileSync(PID_FILE,process.pid.toString()),console.log(`üìÑ PID file written: ${PID_FILE} (PID: ${process.pid})`)}catch(e){console.error("‚ùå Failed to write PID file:",e)}}function cleanupPidFile(){try{fs.existsSync(PID_FILE)&&(fs.unlinkSync(PID_FILE),console.log("üóëÔ∏è PID file cleaned up"))}catch(e){console.error("‚ö†Ô∏è Failed to cleanup PID file:",e)}}async function cleanup(){console.log("üõë ===== SERVER SHUTTING DOWN ====="),console.log("Time:",(new Date).toISOString());for(const[e,process]of activeProcesses)console.log(`Stopping process ${e}`),process.kill("SIGTERM");activeProcesses.clear(),sessions.clear(),lastAssistantMessageIds.clear(),cleanupPidFile(),console.log("‚úÖ Cleanup complete"),process.exit(0)}console.log("===== SERVER STARTUP LOGGING ====="),console.log(`üìÖ Starting server at: ${(new Date).toISOString()}`),console.log(`üìÅ Current directory: ${process.cwd()}`),console.log(`üñ•Ô∏è Platform: ${process.platform}`),console.log(`üî¢ Node version: ${process.version}`),console.log(`üìç Script location: ${__filename}`),console.log(`üåê Attempting to bind to port: ${PORT}`),console.log("üè∑Ô∏è Process argv:",process.argv),console.log("üîß Environment NODE_ENV:",process.env.NODE_ENV||"not set"),console.log("=================================="),httpServer.listen(PORT,"0.0.0.0",()=>{console.log("‚úÖ ===== SERVER SUCCESSFULLY STARTED ====="),console.log(`üöÄ Claude Direct Server running on http://0.0.0.0:${PORT}`),console.log("üîë Using claude CLI directly - NO SDK, NO API KEY"),console.log("üìù Running in "+("linux"===process.platform?"WSL":"Windows")),console.log("üîå WebSocket ready for connections"),console.log("üßπ GC enabled: "+(global.gc?"YES":"NO (run with --expose-gc)")),console.log("========================================="),writePidFile(),process.send&&(console.log("üì§ Sending ready signal to parent process"),process.send({type:"server-ready",port:PORT}))}),httpServer.on("error",e=>{console.error("‚ùå ===== SERVER STARTUP ERROR ====="),console.error("Failed to start server:",e),console.error("Error code:",e.code),console.error("Error message:",e.message),"EADDRINUSE"===e.code&&(console.error(`Port ${PORT} is already in use. Try killing the process using it:`),console.error(`  Windows: netstat -ano | findstr :${PORT}`),console.error("  Then: taskkill /F /PID <pid>"),console.error(`  Linux/Mac: lsof -i :${PORT}`),console.error("  Then: kill -9 <pid>")),console.error("==================================="),process.exit(1)}),process.on("uncaughtException",e=>{console.error("üí• ===== UNCAUGHT EXCEPTION ====="),console.error("Error:",e),console.error("Stack:",e.stack),console.error("=================================");try{for(const[e,process]of activeProcesses)process.kill("SIGTERM");activeProcesses.clear(),sessions.clear(),lastAssistantMessageIds.clear()}catch(e){console.error("Cleanup error:",e)}process.exit(1)}),process.on("unhandledRejection",(e,s)=>{console.error("üí• ===== UNHANDLED REJECTION ====="),console.error("Reason:",e),console.error("Promise:",s),console.error("==================================");const o=process.memoryUsage();console.log("Memory usage:"),console.log(`  RSS: ${Math.round(o.rss/1024/1024)}MB`),console.log(`  Heap Used: ${Math.round(o.heapUsed/1024/1024)}MB`),console.log(`  Heap Total: ${Math.round(o.heapTotal/1024/1024)}MB`)}),process.on("SIGTERM",cleanup),process.on("SIGINT",cleanup),process.on("beforeExit",cleanup);