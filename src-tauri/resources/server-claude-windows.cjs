console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("ü™ü YURUCODE SERVER: Windows External Server (server-claude-windows.cjs)"),console.log("ü™ü Platform-specific server for Windows - aligned with macOS flow"),console.log("ü™ü Edit code at: server-claude-windows.cjs"),console.log("ü™ü Uses external file for easier debugging and updates"),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");const originalConsole={log:console.log.bind(console),error:console.error.bind(console),warn:console.warn.bind(console),info:console.info.bind(console),debug:console.debug.bind(console)};console.log=function(...e){try{originalConsole.log(...e)}catch(e){if("EBADF"!==e.code&&"EPIPE"!==e.code)throw e}},console.error=function(...e){try{originalConsole.error(...e)}catch(e){if("EBADF"!==e.code&&"EPIPE"!==e.code)throw e}},console.warn=function(...e){try{originalConsole.warn(...e)}catch(e){if("EBADF"!==e.code&&"EPIPE"!==e.code)throw e}},console.info=function(...e){try{originalConsole.info(...e)}catch(e){if("EBADF"!==e.code&&"EPIPE"!==e.code)throw e}},console.debug=function(...e){try{originalConsole.debug(...e)}catch(e){if("EBADF"!==e.code&&"EPIPE"!==e.code)throw e}};const wrapperState={sessions:new Map,stats:{apiCalls:0,totalTokens:0,compacts:0}};function getWrapperSession(e){return wrapperState.sessions.has(e)||(wrapperState.sessions.set(e,{id:e,inputTokens:0,outputTokens:0,totalTokens:0,accumulatedInputTokens:0,accumulatedOutputTokens:0,accumulatedTotalTokens:0,accumulatedCacheRead:0,accumulatedCacheCreation:0,messageCount:0,apiResponses:[],compactCount:0,wasCompacted:!1,tokensSaved:0}),console.log(`‚úÖ [WRAPPER] Created session: ${e}`)),wrapperState.sessions.get(e)}function processWrapperLine(e,s){if(!e||!e.trim())return e;const o=getWrapperSession(s);try{const s=JSON.parse(e);if(wrapperState.stats.apiCalls++,console.log(`üì° [WRAPPER] API ${s.type} #${wrapperState.stats.apiCalls}`),o.apiResponses.push({timestamp:Date.now(),type:s.type,data:{...s}}),"user"!==s.type&&"assistant"!==s.type||o.messageCount++,"user"===s.type&&s.message?.content){const e="string"==typeof s.message.content?s.message.content:Array.isArray(s.message.content)?s.message.content.find(e=>"text"===e.type)?.text:"";if("/compact"===e?.trim()){o.compactInProgress=!0,console.log("üóúÔ∏è [WRAPPER] Detected /compact command starting");const e=o.history.slice(-20);let s="‚úÖ Conversation compacted successfully!\n\n";s+="üìä Compaction Summary:\n",s+=`‚Ä¢ Messages compressed: ${o.messageCount}\n`,s+=`‚Ä¢ Tokens saved: ${o.totalTokens.toLocaleString()}\n`;const t=e.filter(e=>"user"===e.type);if(t.length>0){s+="\nüìù Recent context:\n";const e=t.slice(-3).map(e=>{const s=e.data?.message?.content;let o="";if("string"==typeof s)o=s;else if(Array.isArray(s)){const e=s.find(e=>"text"===e.type);o=e?.text||""}return o=o.replace(/\n+/g," ").trim(),o.length>80&&(o=o.substring(0,77)+"..."),o}).filter(e=>e);e.forEach((e,o)=>{s+=`‚Ä¢ ${e}\n`})}s+="\n‚ú® Context reset - you can continue normally.",o.compactSummary=s,console.log(`üóúÔ∏è [WRAPPER] Generated compact summary: ${s.substring(0,100)}...`)}}const t=o.compactInProgress||o.isCompacting;if(s.usage&&!t){const e=s.usage.input_tokens||0,t=s.usage.output_tokens||0,n=s.usage.cache_creation_input_tokens||0,i=s.usage.cache_read_input_tokens||0;o.inputTokens=e,o.outputTokens=t,o.cacheCreationTokens=n,o.cacheReadTokens=i,o.totalTokens=e+t,o.accumulatedInputTokens+=e,o.accumulatedOutputTokens+=t,o.accumulatedCacheRead+=i,o.accumulatedCacheCreation+=n;o.accumulatedTotalTokens;o.accumulatedTotalTokens+=e+t;const r=e+t;wrapperState.stats.totalTokens+=r;const a=Math.round(o.accumulatedTotalTokens/2e3);console.log(`üìä [WRAPPER] TOKENS +${r} ‚Üí ${o.accumulatedTotalTokens}/200000 (${a}%)`),(n>0||i>0)&&console.log(`   üì¶ Cache: creation=${n}, read=${i} (cache_read doesn't count toward 200k limit)`)}else s.usage&&t&&console.log("üóúÔ∏è [WRAPPER] Compact operation tokens (not accumulated):",s.usage);if("assistant"===s.type&&o.compactInProgress&&s.message?.content){let e="";"string"==typeof s.message.content?e=s.message.content:Array.isArray(s.message.content)&&(e=s.message.content.filter(e=>"text"===e.type).map(e=>e.text).join("")),e&&(o.compactSummary=e,console.log(`üóúÔ∏è [WRAPPER] Captured compact summary: ${e.substring(0,100)}...`))}if("result"===s.type&&(!s.usage||0===s.usage.input_tokens&&0===s.usage.output_tokens)&&o.totalTokens>0){const e=o.totalTokens;console.log(`üóúÔ∏è [WRAPPER] COMPACTION DETECTED! Saved ${e} tokens`),o.compactCount++,o.wasCompacted=!0,o.tokensSaved+=e,wrapperState.stats.compacts++,o.inputTokens=0,o.outputTokens=0,o.totalTokens=0,o.cacheCreationTokens=0,o.cacheReadTokens=0,o.accumulatedInputTokens=0,o.accumulatedOutputTokens=0,o.accumulatedTotalTokens=0,o.accumulatedCacheRead=0,o.accumulatedCacheCreation=0,o.compactSummary?(s.result=o.compactSummary,delete o.compactSummary):s.result&&""!==s.result||(s.result=`Conversation compacted. Saved ${e.toLocaleString()} tokens.`),s.wrapper_compact={savedTokens:e,totalSaved:o.tokensSaved,compactCount:o.compactCount},o.compactInProgress=!1,console.log("üóúÔ∏è [WRAPPER] Compaction complete")}return s.wrapper={enabled:!0,tokens:{total:o.accumulatedTotalTokens,input:o.accumulatedInputTokens,output:o.accumulatedOutputTokens,cache_read:o.accumulatedCacheRead||0,cache_creation:o.accumulatedCacheCreation||0,lastRequest:{input:o.inputTokens,output:o.outputTokens,total:o.totalTokens}},compaction:{count:o.compactCount,wasCompacted:o.wasCompacted,tokensSaved:o.tokensSaved}},JSON.stringify(s)}catch(s){return e}}console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("üéØ WRAPPER EMBEDDED - Token tracking and compaction enabled"),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");const{execSync:execSync,spawn:spawn}=require("child_process"),fs=require("fs"),{existsSync:existsSync,mkdirSync:mkdirSync,readFileSync:readFileSync,writeFileSync:writeFileSync,unlinkSync:unlinkSync}=fs,{dirname:dirname,join:join,isAbsolute:isAbsolute}=require("path"),{createServer:createServer}=require("http"),{Server:Server}=require("socket.io"),{homedir:homedir,platform:platform}=require("os");let CLAUDE_PATH="claude";const isWindows="win32"===platform();let CLAUDE_EXECUTION_MODE="auto",NATIVE_WINDOWS_CLAUDE_PATH=null,WSL_CLAUDE_PATH=null;function loadClaudeSettings(){try{const e=isWindows?join(process.env.APPDATA||process.env.USERPROFILE,"yurucode","claude_settings.json"):join(homedir(),".config","yurucode","claude_settings.json");if(existsSync(e)){const s=JSON.parse(readFileSync(e,"utf8"));console.log("üìã Loaded Claude settings:",s.settings?.executionMode||"not set"),s.settings?.executionMode&&(CLAUDE_EXECUTION_MODE=s.settings.executionMode),s.detection?.nativeWindows?.path&&(NATIVE_WINDOWS_CLAUDE_PATH=s.detection.nativeWindows.path,console.log("üéØ Native Windows Claude path:",NATIVE_WINDOWS_CLAUDE_PATH)),s.detection?.wsl?.path&&(WSL_CLAUDE_PATH=s.detection.wsl.path,console.log("üéØ WSL Claude path:",WSL_CLAUDE_PATH))}}catch(e){console.log("‚ö†Ô∏è Could not load Claude settings, using defaults:",e.message)}}function windowsToWslPath(e){if(!e)return e;const s=e.replace(/\\/g,"/"),o=s.match(/^([A-Z]):(.*)/i);return o?`/mnt/${o[1].toLowerCase()}${o[2]}`:s}function wslToWindowsPath(e){if(!e)return e;const s=e.match(/^\/mnt\/([a-z])(.*)/i);return s?`${s[1].toUpperCase()}:${s[2].replace(/\//g,"\\")}`:e}function createNativeWindowsClaudeCommand(e,s,o){let t=NATIVE_WINDOWS_CLAUDE_PATH||"claude",n=null,i=null;if(t.endsWith(".cmd")){console.log("üì¶ Detected .cmd file, looking for Node.js and actual JS file...");const s=["C:\\Program Files\\nodejs\\node.exe","C:\\Program Files (x86)\\nodejs\\node.exe",process.env.ProgramFiles+"\\nodejs\\node.exe",process.env["ProgramFiles(x86)"]+"\\nodejs\\node.exe"].filter(Boolean);for(const e of s)if(existsSync(e)){n=e;break}if(!n){const e=require("path").dirname(t),s=require("path").join(e,"node.exe");existsSync(s)&&(n=s,console.log(`‚úÖ Found Node.js in npm directory: ${n}`))}if(!n)try{const{execSync:e}=require("child_process"),s=e("where node",{encoding:"utf8",windowsHide:!0,stdio:["pipe","pipe","ignore"]}).trim();if(s){const e=s.split("\n").map(e=>e.trim()).filter(e=>e.endsWith(".exe"));e.length>0&&(n=e[0],console.log(`‚úÖ Found Node.js via PATH: ${n}`))}}catch(e){try{const e=execSync('powershell -Command "Get-Command node | Select-Object -ExpandProperty Source"',{encoding:"utf8",windowsHide:!0,stdio:["pipe","pipe","ignore"]}).trim();e&&e.endsWith(".exe")&&(n=e,console.log(`‚úÖ Found Node.js via PowerShell: ${n}`))}catch(e){console.error("‚ö†Ô∏è Could not find Node.js via where or PowerShell")}}const o=require("path"),r=o.dirname(t);console.log(`üìÇ Looking for Claude JS relative to: ${r}`);const a=[o.join(r,"node_modules","@anthropic-ai","claude-cli","bin","claude.js"),o.join(r,"..","@anthropic-ai","claude-cli","bin","claude.js"),o.join(r,"..","node_modules","@anthropic-ai","claude-cli","bin","claude.js"),o.join(process.env.APPDATA||"","npm","node_modules","@anthropic-ai","claude-cli","bin","claude.js"),t.replace(".cmd",".js"),t.replace("claude.cmd","..\\@anthropic-ai\\claude-cli\\bin\\claude.js"),o.join(r,"node_modules","claude","bin","claude.js"),o.join(r,"..","lib","node_modules","@anthropic-ai","claude-cli","bin","claude.js")].filter(Boolean);console.log(`üîç Checking ${a.length} possible paths for Claude JS...`);for(const e of a){const s=existsSync(e);if(console.log(`  ${s?"‚úÖ":"‚ùå"} ${e}`),s){i=e;break}}n&&i?(console.log("‚úÖ Using Node.js to run Claude directly:"),console.log(`  Node: ${n}`),console.log(`  Claude JS: ${i}`),t=n,e=[i,...e]):n?i||(console.error("‚ùå Could not find Claude JavaScript file"),console.error(`  Checked paths relative to: ${r}`),console.error(`  Node.js found at: ${n}`),console.log("‚ö†Ô∏è Falling back to .cmd file execution with shell")):(console.error("‚ùå Could not find Node.js executable"),console.error("  Checked standard paths and PATH environment"),console.error("  Please ensure Node.js is installed and in PATH"),console.log("‚ö†Ô∏è Falling back to .cmd file execution with shell"))}if(console.log("üñ•Ô∏è Creating native Windows Claude command"),console.log(`  Claude path: ${t}`),console.log(`  Working dir: ${s}`),console.log(`  Args: ${e.join(" ")}`),o){const s=require("fs"),n=require("path"),i=require("os"),r=n.join(i.tmpdir(),`yurucode-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}.txt`);try{s.writeFileSync(r,o,"utf8"),console.log(`  Temp file: ${r} (${o.length} chars)`)}catch(e){throw console.error(`‚ùå Failed to write temp file: ${e.message}`),e}return[t,e,!0,r]}return[t,e,!1,null]}function getClaudeCommand(e,s,o){loadClaudeSettings();let t=s;if("native-windows"===CLAUDE_EXECUTION_MODE&&NATIVE_WINDOWS_CLAUDE_PATH)return console.log("üñ•Ô∏è Using native Windows Claude execution"),createNativeWindowsClaudeCommand(e,s,o);if("wsl"===CLAUDE_EXECUTION_MODE||isWindows&&!NATIVE_WINDOWS_CLAUDE_PATH)return console.log("üêß Using WSL Claude execution"),t=windowsToWslPath(s),createWslClaudeCommand(e,t,o);if("auto"===CLAUDE_EXECUTION_MODE){if(NATIVE_WINDOWS_CLAUDE_PATH)return console.log("ü§ñ Auto mode: Using native Windows Claude"),createNativeWindowsClaudeCommand(e,s,o);if(isWindows)return console.log("ü§ñ Auto mode: Falling back to WSL"),t=windowsToWslPath(s),createWslClaudeCommand(e,t,o)}return[CLAUDE_PATH,e,!1,null]}function createWslClaudeCommand(e,s,o){const t="C:\\Windows\\System32\\wsl.exe";if(!s)throw new Error("Working directory is required for WSL Claude command");const n=s;if(o){const{execFileSync:s}=require("child_process");let i=null,r="yuru";try{r=s(t,["-e","bash","-c","whoami"],{encoding:"utf8",windowsHide:!0}).trim(),console.log(`üîç WSL user: ${r}`)}catch(e){console.log(`‚ö†Ô∏è Could not detect WSL user, using default: ${r}`)}try{console.log("üîé Finding Claude path by sourcing .bashrc...");const e=s(t,["-e","bash","-c",`. /home/${r}/.bashrc 2>/dev/null && type claude 2>/dev/null`],{encoding:"utf8",windowsHide:!0}).trim();if(e&&(console.log(`üîç 'type claude' output: ${e}`),e.includes("is aliased to"))){const s=e.match(/is aliased to [`']([^`']+)[`']/);s&&(i=s[1],console.log(`‚úÖ CLAUDE PATH FROM ALIAS: ${i}`))}}catch(e){console.log("‚ö†Ô∏è Could not get claude from .bashrc")}if(!i){const e=`/home/${r}/.claude/local/claude`;console.log(`üîé Checking known location: ${e}`);try{"yes"===s(t,["-e","bash","-c",`[ -f "${e}" ] && echo "yes"`],{encoding:"utf8",windowsHide:!0}).trim()&&(i=e,console.log(`‚úÖ CLAUDE FOUND AT: ${i}`))}catch(e){}}if(!i)try{i=s(t,["-e","bash","-c","which claude 2>/dev/null"],{encoding:"utf8",windowsHide:!0}).trim(),i&&console.log(`‚úÖ CLAUDE PATH FROM WHICH: ${i}`)}catch(e){}if(!i){const e=`Claude CLI not found in WSL. Checked: /home/${r}/.claude/local/claude. Please ensure Claude is installed.`;throw console.error(`‚ùå ${e}`),new Error(e)}const a=e.map(e=>e.includes(" ")||e.includes(":")||e.includes("(")||e.includes(")")||e.includes(",")?`'${e.replace(/'/g,"'\\''")}'`:e).join(" "),c=`/tmp/yurucode-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}.txt`,l=require("fs"),d=require("path"),u=require("os"),g=d.join(u.tmpdir(),`yurucode-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}.txt`);try{l.writeFileSync(g,o,"utf8")}catch(e){throw console.error(`‚ùå Failed to write temp file: ${e.message}`),e}const m=`/mnt/${g[0].toLowerCase()}${g.substring(2).replace(/\\/g,"/")}`,p=`trap 'rm -f "${c}"' EXIT; cd "${n}" && cat "${m}" > "${c}" && rm -f "${m}" && cat "${c}" | ${i} ${a} 2>&1`;return console.log("üîç WSL script (main message):"),console.log(`  Working dir: ${n}`),console.log(`  Claude path: ${i}`),console.log(`  Args: ${a}`),console.log(`  Message length: ${o.length} chars`),console.log(`  Windows temp file: ${g}`),console.log(`  WSL temp file: ${c}`),[t,["-e","bash","-c",p],!0,g]}{const{execFileSync:s}=require("child_process"),o="C:\\Windows\\System32\\wsl.exe";let t=null,i="user";try{i=s(o,["-e","bash","-c","whoami"],{encoding:"utf8",windowsHide:!0}).trim(),console.log(`üîç WSL user detected for title gen: ${i}`)}catch(e){console.warn("‚ö†Ô∏è Could not detect WSL user for title gen, using default")}const r=[`/home/${i}/.claude/local/node_modules/.bin/claude`,"~/.npm-global/bin/claude","~/node_modules/.bin/claude","/usr/local/bin/claude","/usr/bin/claude","~/.local/bin/claude"];for(const e of r)try{const n=e.startsWith("~")?`[ -f "${e.replace("~","$HOME")}" ] && echo "exists"`:`[ -f "${e}" ] && echo "exists"`;if("exists"===s(o,["-e","bash","-c",n],{encoding:"utf8",windowsHide:!0}).trim()){if(e.startsWith("~")){const n=s(o,["-e","bash","-c","echo $HOME"],{encoding:"utf8",windowsHide:!0}).trim();t=e.replace("~",n)}else t=e;break}}catch(e){}if(!t)try{const e=s(o,["-e","bash","-c","which claude"],{encoding:"utf8",windowsHide:!0}).trim();e&&(t=e)}catch(e){}t||(t=`/home/${i}/.claude/local/node_modules/.bin/claude`,console.log(`‚ö†Ô∏è Claude not found for title gen, using default: ${t}`));const a=e.map(e=>e.includes(" ")||e.includes(":")||e.includes("(")||e.includes(")")||e.includes(",")?`'${e.replace(/'/g,"'\\''")}'`:e).join(" "),c=`cd "${n}" && ${t} ${a} 2>&1`;return console.log(`üîç WSL script (title gen) with args: ${a}`),[o,["-e","bash","-c",c],!1]}}if(isWindows){if(loadClaudeSettings(),!NATIVE_WINDOWS_CLAUDE_PATH){console.log("üîç Auto-detecting native Windows Claude CLI...");const e=process.env.APPDATA||"",s=process.env.USERPROFILE||"",o=process.env.LOCALAPPDATA||"",t=[join(e,"npm","claude.cmd"),join(e,"npm","claude.exe"),join(s,".claude","local","claude.exe"),join(o,"Programs","claude","claude.exe"),join(o,"Claude","claude.exe"),join(s,"scoop","apps","claude","current","claude.exe"),join(s,"scoop","shims","claude.exe"),"C:\\ProgramData\\chocolatey\\bin\\claude.exe","C:\\Program Files\\Claude\\claude.exe","C:\\Program Files (x86)\\Claude\\claude.exe"].filter(Boolean);for(const e of t)try{if(existsSync(e)){NATIVE_WINDOWS_CLAUDE_PATH=e,console.log(`‚úÖ Found native Windows Claude at: ${e}`);break}}catch(e){}if(!NATIVE_WINDOWS_CLAUDE_PATH)try{const e=execSync("where claude",{encoding:"utf8",windowsHide:!0,stdio:["pipe","pipe","ignore"]}).trim();if(e){const s=e.split("\n").map(e=>e.trim()).filter(e=>e);for(const e of s)if(e.endsWith(".exe")||e.endsWith(".cmd")){NATIVE_WINDOWS_CLAUDE_PATH=e,console.log(`‚úÖ Found native Windows Claude via 'where': ${e}`);break}}}catch(e){console.log('‚ö†Ô∏è "where claude" command failed or claude not in PATH')}if(!NATIVE_WINDOWS_CLAUDE_PATH)try{execSync("claude --version",{encoding:"utf8",windowsHide:!0,stdio:["pipe","pipe","ignore"],timeout:5e3}),NATIVE_WINDOWS_CLAUDE_PATH="claude",console.log("‚úÖ 'claude' command is available in PATH")}catch(e){}}console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("üîç PLATFORM: Windows detected"),console.log("üîç CLAUDE EXECUTION MODE:",CLAUDE_EXECUTION_MODE),NATIVE_WINDOWS_CLAUDE_PATH&&console.log("‚úÖ Native Windows Claude available:",NATIVE_WINDOWS_CLAUDE_PATH),WSL_CLAUDE_PATH&&console.log("‚úÖ WSL Claude available:",WSL_CLAUDE_PATH),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),!NATIVE_WINDOWS_CLAUDE_PATH||"native-windows"!==CLAUDE_EXECUTION_MODE&&"auto"!==CLAUDE_EXECUTION_MODE?NATIVE_WINDOWS_CLAUDE_PATH&&!WSL_CLAUDE_PATH?(CLAUDE_PATH="NATIVE_WINDOWS_CLAUDE",console.log("üéØ Using native Windows Claude CLI (only option available)")):(CLAUDE_PATH="WSL_CLAUDE",console.log("üéØ Using WSL Claude CLI")):(CLAUDE_PATH="NATIVE_WINDOWS_CLAUDE",console.log("üéØ Using native Windows Claude CLI"))}else{const e=[join(homedir(),".npm-global/bin/claude"),"/opt/homebrew/bin/claude","/usr/local/bin/claude","/usr/bin/claude",process.env.CLAUDE_PATH].filter(Boolean);for(const s of e)try{if(existsSync(s)){CLAUDE_PATH=s,console.log(`‚úÖ Found Claude CLI at: ${CLAUDE_PATH}`);break}}catch(e){}if("claude"===CLAUDE_PATH)try{const e=execSync("which claude",{encoding:"utf8"}).trim();e&&(CLAUDE_PATH=e,console.log(`‚úÖ Found Claude CLI via which: ${CLAUDE_PATH}`))}catch(e){}if("claude"===CLAUDE_PATH)try{const e=execSync("whereis claude",{encoding:"utf8"}).trim().match(/claude:\s+(.+)/);if(e&&e[1]){const s=e[1].split(/\s+/);for(const e of s)if(existsSync(e)){CLAUDE_PATH=e,console.log(`‚úÖ Found Claude CLI via whereis: ${CLAUDE_PATH}`);break}}}catch(e){console.warn("‚ö†Ô∏è Claude CLI not found via whereis. Using 'claude' and hoping for the best.")}}const express=require("express"),cors=require("cors"),net=require("net"),app=express(),httpServer=createServer(app),io=new Server(httpServer,{cors:{origin:"*",methods:["GET","POST"]},transports:["websocket","polling"],pingTimeout:12e5,pingInterval:3e4,upgradeTimeout:6e4,maxHttpBufferSize:5e8,perMessageDeflate:!1,httpCompression:!1});app.use(cors()),app.use(express.json());const PORT=(()=>{if(process.env.PORT){const e=parseInt(process.env.PORT);return console.log(`‚úÖ Using PORT from Rust: ${e}`),e}console.log("üîç Finding available port in range 60000-61000...");let e=6e4+Math.floor(1001*Math.random());for(let s=0;s<100;s++){const o=6e4+(e-6e4+s)%1001,t=net.createServer();try{return t.listen(o,"127.0.0.1"),t.close(),console.log(`‚úÖ Found available port: ${o}`),o}catch(e){}}return console.log("‚ö†Ô∏è Could not find available port, using 3001"),3001})();let sessions=new Map,activeProcesses=new Map,activeProcessStartTimes=new Map,activeBashProcesses=new Map,lastAssistantMessageIds=new Map,allAssistantMessageIds=new Map,streamHealthChecks=new Map,streamTimeouts=new Map,stoppedSessions=new Map,killedProcessPIDs=new Set,isSpawningProcess=!1;const processSpawnQueue=[],spawningProcesses=new Map,pendingInterrupts=new Map,pendingStreamingFalseTimers=new Map,STREAMING_FALSE_DEBOUNCE_MS=600;function cancelPendingStreamingFalse(e){const s=pendingStreamingFalseTimers.get(e);s&&(clearTimeout(s.timer),pendingStreamingFalseTimers.delete(e),console.log(`üîÑ [${e}] Cancelled pending streaming=false (new process starting)`))}async function generateTitle(e,s,o,t){try{console.log(`üè∑Ô∏è Generating title for session ${e}`),console.log(`üè∑Ô∏è Message preview: "${s}"`);const n=`user message: "${s.substring(0,200)}"\ntask: reply with ONLY 1-3 words describing what user wants. lowercase only. no punctuation. be extremely concise. examples: "echo command", "file search", "debug issue"`,i=["-p",n,"--print","--output-format","json","--model","claude-sonnet-4-5-20250929"];console.log(`üè∑Ô∏è Title prompt: "${n}"`);const r={...process.env};if(isWindows&&"native-windows"===CLAUDE_EXECUTION_MODE&&NATIVE_WINDOWS_CLAUDE_PATH){r.SHELL="C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",r.COMSPEC=process.env.COMSPEC||"C:\\Windows\\System32\\cmd.exe";const e=["C:\\Program Files\\nodejs","C:\\Program Files (x86)\\nodejs",process.env.ProgramFiles&&`${process.env.ProgramFiles}\\nodejs`].filter(Boolean);for(const s of e)if(existsSync(s)&&!r.PATH?.includes(s)){r.PATH=`${s};${r.PATH||""}`;break}}else if(!isWindows){const e="/opt/homebrew/bin";r.PATH?.includes(e)||(r.PATH=`${e}:${r.PATH||"/usr/bin:/bin"}`)}const a=join(homedir(),".yurucode-title-gen");try{if(!existsSync(a)){const{mkdirSync:e}=require("fs");e(a,{recursive:!0}),console.log("üìÅ Created title generation directory:",a)}}catch(e){console.log("‚ö†Ô∏è Could not create title gen directory, using home:",e.message)}const c=isWindows?(()=>{const[e,s,o,t]=getClaudeCommand(i,a,null);if("C:\\Windows\\System32\\wsl.exe"===e){const{execSync:e}=require("child_process");let s="user";try{s=e('C:\\Windows\\System32\\wsl.exe -e bash -c "whoami"',{encoding:"utf8",windowsHide:!0}).trim()}catch(e){}const o=`/home/${s}/.yurucode-title-gen`;try{e(`C:\\Windows\\System32\\wsl.exe -e bash -c "mkdir -p ${o}"`,{windowsHide:!0})}catch(e){console.log("‚ö†Ô∏è Could not create WSL title gen directory:",e.message)}}const n={cwd:a,env:r,stdio:["pipe","pipe","pipe"],windowsHide:!0,detached:!1};if((e.endsWith(".cmd")||e.endsWith(".bat"))&&!e.endsWith("node.exe")){n.shell=!0;const e=["C:\\Program Files\\nodejs","C:\\Program Files (x86)\\nodejs",process.env.ProgramFiles+"\\nodejs"].filter(Boolean);for(const s of e)if(existsSync(s)){n.env={...n.env},n.env.PATH=s+";"+(n.env.PATH||process.env.PATH),console.log(`‚úÖ Added Node.js to PATH for .cmd execution: ${s}`);break}}return spawn(e,s,n)})():spawn(CLAUDE_PATH,i,{cwd:a,env:r,stdio:["pipe","pipe","pipe"],windowsHide:!0,detached:!1});let l="",d="";c.stdout.on("data",e=>{l+=e.toString(),console.log(`üè∑Ô∏è Title generation stdout: ${e.toString()}`)}),c.stderr.on("data",e=>{d+=e.toString(),console.log(`üè∑Ô∏è Title generation stderr: ${e.toString()}`)}),c.on("close",s=>{console.log(`üè∑Ô∏è Title generation process closed with code ${s}`),console.log(`üè∑Ô∏è Full output: "${l}"`),d&&console.log(`üè∑Ô∏è Error output: "${d}"`);try{const s=l.trim().split("\n"),n=s[s.length-1];console.log(`üè∑Ô∏è Parsing last line: "${n}"`);const i=JSON.parse(n),r=i.completion||i.result;if(r){let s=r.toLowerCase().replace(/[^\w\s]/g,"").trim().substring(0,30);if(s&&s.length>2){console.log(`üè∑Ô∏è Generated title: "${s}" - emitting to client`);const n=`title:${e}`;console.log(`üè∑Ô∏è Emitting event: ${n} with data:`,{title:s}),o.emit(n,{title:s}),t&&t()}else console.log(`üè∑Ô∏è Title too short or empty: "${s}"`)}else console.log("üè∑Ô∏è No title text in response:",i)}catch(e){console.error("üè∑Ô∏è Failed to parse title response:",e),console.error("üè∑Ô∏è Raw output was:",l)}}),c.on("error",e=>{console.error("üè∑Ô∏è Failed to spawn title generation process:",e)}),c.stdin.end()}catch(e){console.error("üè∑Ô∏è Failed to generate title:",e)}}const MAX_MESSAGE_HISTORY=1e3,MAX_LINE_BUFFER_SIZE=52428800;app.get("/health",(e,s)=>{s.json({status:"ok",pid:process.pid,service:"yurucode-claude",claudeCodeLoaded:!0})}),app.delete("/claude-project/:projectPath",async(e,s)=>{try{const{projectPath:o}=e.params,t=join(homedir(),".claude","projects",o);if(console.log("Deleting project:",t),!existsSync(t))return s.status(404).json({error:"project not found"});const{rm:n}=await import("fs/promises");await n(t,{recursive:!0,force:!0}),console.log("Project deleted successfully"),s.json({success:!0})}catch(e){console.error("Error deleting project:",e),s.status(500).json({error:"Failed to delete project",details:e.message})}}),app.delete("/claude-session/:projectPath/:sessionId",async(e,s)=>{try{const{projectPath:o,sessionId:t}=e.params,n=join(homedir(),".claude","projects",o,`${t}.jsonl`);if(console.log("Deleting session:",n),!existsSync(n))return s.status(404).json({error:"session not found"});const{unlink:i}=await import("fs/promises");await i(n),console.log("Session deleted successfully"),s.json({success:!0})}catch(e){console.error("Error deleting session:",e),s.status(500).json({error:"Failed to delete session",details:e.message})}}),app.get("/claude-session/:projectPath/:sessionId",async(e,s)=>{try{const{projectPath:o,sessionId:t}=e.params;if(console.log("Loading session request:"),console.log("  - Raw projectPath:",o),console.log("  - SessionId:",t),console.log("  - Platform:",platform()),console.log("  - Execution mode:",CLAUDE_EXECUTION_MODE),isWindows&&"native-windows"!==CLAUDE_EXECUTION_MODE){let e="user";try{const{execSync:s}=require("child_process");e=s('C:\\Windows\\System32\\wsl.exe -e bash -c "whoami"',{encoding:"utf8",windowsHide:!0}).trim()}catch(e){console.warn("Could not detect WSL user, using default")}const n=`/home/${e}/.claude/projects/${o}/${t}.jsonl`;console.log("  - WSL path:",n);try{const{execSync:e}=require("child_process"),i=e(`powershell.exe -NoProfile -Command "& {wsl.exe -e bash -c 'cat \\"${n}\\" 2>/dev/null'}"`,{encoding:"utf8",windowsHide:!0,maxBuffer:52428800});console.log("Raw file content:",i.replace(/\n/g,"\\n").replace(/\r/g,"\\r")),console.log("Total file size:",i.length,"characters");const r=i[i.length-1];console.log("File ends with:","\n"===r?"newline":"$"===r?"dollar":"char: "+r);const a=[];let c=0,l=0,d=0,u=0;for(;c<i.length;){for(u++;c<i.length&&/\s/.test(i[c]);)c++;if(c>=i.length)break;if("{"!==i[c]){console.log("Warning: Expected { at position",c,"but found:",i[c]);const e=i.indexOf("\n",c);if(-1===e)break;c=e+1;continue}let e=0,s=!1,o=!1,t=-1;for(let n=c;n<i.length;n++){const r=i[n];if(o)o=!1;else if("\\"!==r)if('"'!==r||o){if(!s)if("{"===r)e++;else if("}"===r&&(e--,0===e)){if(!(n+1<i.length)){t=n+1;break}{const e=i[n+1];if("$"===e||"\n"===e||"\r"===e){t=n+1;break}}}}else s=!s;else o=!0}if(-1===t){console.log("Warning: Could not find end of JSON object starting at position",c);break}const n=i.substring(c,t);try{const e=JSON.parse(n);if("user"===e.role){if(!e.content){c=t,c<i.length&&"$"===i[c]&&c++,c<i.length&&"\n"===i[c]&&c++,c<i.length&&"\r"===i[c]&&c++;continue}if(!("string"==typeof e.content?e.content:Array.isArray(e.content)&&e.content.length>0?e.content.map(e=>e.text||"").join(""):"").trim()){c=t,c<i.length&&"$"===i[c]&&c++,c<i.length&&"\n"===i[c]&&c++,c<i.length&&"\r"===i[c]&&c++;continue}}a.push(e),l++,l<=5&&("summary"===e.type?console.log(`Line ${u}: Added summary:`,e.summary||""):"user"===e.type?console.log(`Line ${u}: Added user message`):"assistant"===e.type?console.log(`Line ${u}: Added assistant message`):e.sessionId&&console.log(`Line ${u}: Added session metadata`))}catch(e){d++,d<=5&&(console.log(`Failed to parse JSON at line ${u}, position ${c}:`,e.message),console.log("JSON output:",n))}c=t,c<i.length&&"$"===i[c]&&c++,c<i.length&&"\n"===i[c]&&c++,c<i.length&&"\r"===i[c]&&c++}console.log(`Processed ${u} lines, successfully parsed ${l} JSON objects from session file`);const g=o.replace(/^([A-Z])--/,"$1:/").replace(/^-/,"/").replace(/-/g,"/");console.log(`Loaded session with ${a.length} messages`),console.log(`Converted project path: ${o} -> ${g}`);let m=null;if(a.length>0){const e=a[a.length-1];("title"===e.type&&e.title||"metadata"===e.type&&e.title||e.title&&!e.role)&&(m=e.title)}if(!m){const e=a.find(e=>"summary"===e.type&&e.summary);e&&(m=e.summary)}if(!m){const e=a.find(e=>"user"===e.role&&e.content);if(e){const s="string"==typeof e.content?e.content:Array.isArray(e.content)&&e.content.find(e=>"text"===e.type)?.text||"";s&&(m=s.substring(0,100))}}m||(m="Untitled session"),s.json({sessionId:t,projectPath:g,messages:a,sessionCount:a.length,title:m})}catch(e){console.error("Error reading session file from WSL:",e.message),s.status(404).json({error:"Session not found"})}}else{const e=join(homedir(),".claude","projects",o,`${t}.jsonl`);if(console.log("  - Full path:",e),!existsSync(e))return console.error("Session not found:",e),s.status(404).json({error:"session not found"});const{readFile:n}=await import("fs/promises");try{const i=await n(e,"utf8"),r=[],a=i.split(/\$|\n/).filter(e=>e.trim());for(const e of a)try{const s=JSON.parse(e);if("user"===s.role){if(!s.content)continue;if(!("string"==typeof s.content?s.content:Array.isArray(s.content)&&s.content.length>0?s.content.map(e=>e.text||"").join(""):"").trim())continue}r.push(s)}catch(e){}let c=null;if(r.length>0){const e=r[r.length-1];("title"===e.type&&e.title||"metadata"===e.type&&e.title||e.title&&!e.role)&&(c=e.title)}if(!c){const e=r.find(e=>"summary"===e.type&&e.summary);e&&(c=e.summary)}if(!c){const e=r.find(e=>"user"===e.role&&e.content);if(e){const s="string"==typeof e.content?e.content:Array.isArray(e.content)&&e.content.find(e=>"text"===e.type)?.text||"";s&&(c=s.substring(0,100))}}c||(c="Untitled session");const l=o.replace(/^([A-Z])--/,"$1:/").replace(/^-/,"/").replace(/-/g,"/");s.json({sessionId:t,projectPath:l,messages:r,sessionCount:r.length,title:c})}catch(e){console.error("Error reading session file:",e),s.status(500).json({error:"Failed to read session",details:e.message})}}}catch(e){console.error("Error loading session:",e),s.status(500).json({error:"Failed to load session",details:e.message})}}),app.get("/claude-analytics",async(e,s)=>{console.log("üìä Loading analytics from all Claude sessions...");try{const e={totalSessions:0,totalMessages:0,totalTokens:0,totalCost:0,tokenBreakdown:{input:0,output:0,cacheCreation:0,cacheRead:0},byModel:{opus:{sessions:0,tokens:0,cost:0},sonnet:{sessions:0,tokens:0,cost:0}},byDate:{},byProject:{}};if(isWindows){const{readdir:s,readFile:o,stat:t}=await import("fs/promises"),n=await import("path");let i=null;if("native-windows"!==CLAUDE_EXECUTION_MODE){const e=["yuru","muuko",process.env.USER,process.env.USERNAME].filter(Boolean),s=["Ubuntu","Ubuntu-20.04","Ubuntu-22.04","Ubuntu-24.04"],o=["\\\\wsl$","\\\\wsl.localhost"];console.log("üìä Analytics: Searching for WSL Claude projects..."),console.log("  Possible users:",e),console.log("  Possible distros:",s);let n=0;for(const r of o){for(const o of s){for(const s of e){const e=`${r}\\${o}\\home\\${s}\\.claude\\projects`;n++;try{await t(e),i=e,console.log(`‚úÖ Found WSL Claude projects at: ${e} (attempt ${n})`);break}catch(e){}}if(i)break}if(i)break}i||console.log(`‚ùå WSL Claude projects not found after ${n} attempts`)}else console.log("üìä Analytics: Native Windows mode - skipping WSL, using Windows projects");if(i)try{const r=await s(i);console.log(`Found ${r.length} projects in WSL directory`);const a=10;for(const c of r.slice(0,a)){const r=n.win32.join(i,c);try{if(!(await t(r)).isDirectory())continue;console.log(`Processing WSL project: ${c}`);const i=(await s(r)).filter(e=>e.endsWith(".jsonl"));console.log(`  Found ${i.length} session files`);const a=20;for(const s of i.slice(0,a))try{const i=n.win32.join(r,s),a=await t(i);if(a.size>10485760){console.log(`  Skipping large file: ${s} (${a.size} bytes)`);continue}console.log(`  Reading session: ${s} (${a.size} bytes)`);const l=(await o(i,"utf8")).split("\n").filter(e=>e.trim());console.log(`    Total lines in file: ${l.length}`);let d=0,u=0,g="sonnet",m=(new Date).toISOString().split("T")[0],p=0;for(const s of l)try{const o=JSON.parse(s);if("assistant"===o.type&&o.message&&o.message.usage){const s=o.message.usage,t=s.input_tokens||0,n=s.output_tokens||0,i=s.cache_creation_input_tokens||0,r=s.cache_read_input_tokens||0;d+=t+n+i,o.message&&o.message.model&&(g=o.message.model.toLowerCase().includes("opus")?"opus":"sonnet");const a="opus"===g;u+=t*(a?15e-6:3e-6)+n*(a?75e-6:15e-6)+i*(a?1875e-8:375e-8)+r*(a?15e-7:3e-7),e.tokenBreakdown.input+=t,e.tokenBreakdown.output+=n,e.tokenBreakdown.cacheCreation+=i,e.tokenBreakdown.cacheRead+=r}"user"!==o.type&&"assistant"!==o.type||p++,o.timestamp&&(m=new Date(o.timestamp).toISOString().split("T")[0])}catch(e){}if(console.log(`    Parsed: ${p} messages, ${d} tokens`),d>0){console.log(`    Session: ${d} tokens, $${u.toFixed(4)}`),e.totalSessions++,e.totalMessages+=2*p,e.totalTokens+=d,e.totalCost+=u;const s="opus"===g?"opus":"sonnet";e.byModel[s].sessions++,e.byModel[s].tokens+=d,e.byModel[s].cost+=u,e.byDate[m]||(e.byDate[m]={sessions:0,messages:0,tokens:0,cost:0}),e.byDate[m].sessions++,e.byDate[m].messages+=2*p,e.byDate[m].tokens+=d,e.byDate[m].cost+=u;const o=c.replace(/-/g,"/");e.byProject[o]||(e.byProject[o]={sessions:0,messages:0,tokens:0,cost:0,lastUsed:a.mtime.getTime()}),e.byProject[o].sessions++,e.byProject[o].messages+=2*p,e.byProject[o].tokens+=d,e.byProject[o].cost+=u}}catch(e){console.error(`  Error processing session ${s}:`,e.message)}}catch(e){console.error(`Error processing project ${c}:`,e.message)}}}catch(e){console.error("Error reading WSL projects directory:",e.message),i=null}if(!i){console.log("WSL mount not accessible, trying Windows path...");const i=n.win32.join(homedir(),".claude","projects");try{const r=await s(i);console.log(`Found ${r.length} projects in Windows directory`);for(const a of r.slice(0,5)){const r=n.win32.join(i,a);if(!(await t(r)).isDirectory())continue;console.log(`Processing Windows project: ${a}`);const c=(await s(r)).filter(e=>e.endsWith(".jsonl"));console.log(`  Found ${c.length} session files`);for(const s of c.slice(0,10))try{const i=n.win32.join(r,s),c=await t(i);if(c.size>10485760){console.log(`  Skipping large file: ${s} (${c.size} bytes)`);continue}console.log(`  Reading session: ${s} (${c.size} bytes)`);const l=(await o(i,"utf8")).split("\n").filter(e=>e.trim());console.log(`    Total lines in file: ${l.length}`);let d=0,u=0,g="sonnet",m=(new Date).toISOString().split("T")[0],p=0;for(const s of l)try{const o=JSON.parse(s);if("assistant"===o.type&&o.message&&o.message.usage){const s=o.message.usage,t=s.input_tokens||0,n=s.output_tokens||0,i=s.cache_creation_input_tokens||0,r=s.cache_read_input_tokens||0;d+=t+n+i,o.message&&o.message.model&&(g=o.message.model.toLowerCase().includes("opus")?"opus":"sonnet");const a="opus"===g;u+=t*(a?15e-6:3e-6)+n*(a?75e-6:15e-6)+i*(a?1875e-8:375e-8)+r*(a?15e-7:3e-7),e.tokenBreakdown.input+=t,e.tokenBreakdown.output+=n,e.tokenBreakdown.cacheCreation+=i,e.tokenBreakdown.cacheRead+=r}"user"!==o.type&&"assistant"!==o.type||p++,o.timestamp&&(m=new Date(o.timestamp).toISOString().split("T")[0])}catch(e){}if(console.log(`    Parsed: ${p} messages, ${d} tokens`),d>0){console.log(`    Session: ${d} tokens, $${u.toFixed(4)}`),e.totalSessions++,e.totalMessages+=2*p,e.totalTokens+=d,e.totalCost+=u;const s="opus"===g?"opus":"sonnet";e.byModel[s].sessions++,e.byModel[s].tokens+=d,e.byModel[s].cost+=u,e.byDate[m]||(e.byDate[m]={sessions:0,messages:0,tokens:0,cost:0}),e.byDate[m].sessions++,e.byDate[m].messages+=2*p,e.byDate[m].tokens+=d,e.byDate[m].cost+=u;const o=a.replace(/-/g,"/");e.byProject[o]||(e.byProject[o]={sessions:0,messages:0,tokens:0,cost:0,lastUsed:c.mtime.getTime()}),e.byProject[o].sessions++,e.byProject[o].messages+=2*p,e.byProject[o].tokens+=d,e.byProject[o].cost+=u}}catch(e){console.error(`  Error processing session ${s}:`,e.message)}}}catch(e){console.error("Error reading Windows projects:",e.message)}}}else{const{readdir:s,readFile:o,stat:t}=await import("fs/promises"),n=join(homedir(),".claude","projects");try{const i=await s(n);for(const r of i){const i=join(n,r);if(!(await t(i)).isDirectory())continue;const a=(await s(i)).filter(e=>e.endsWith(".jsonl"));for(const s of a)try{const t=join(i,s),n=(await o(t,"utf8")).split("\n").filter(e=>e.trim());let a=0,c=0,l="sonnet",d=(new Date).toISOString().split("T")[0],u=0;for(const s of n)try{const o=JSON.parse(s);if("assistant"===o.type&&o.message&&o.message.usage){const s=o.message.usage,t=s.input_tokens||0,n=s.output_tokens||0,i=s.cache_creation_input_tokens||0,r=s.cache_read_input_tokens||0;a+=t+n+i,o.message&&o.message.model&&(l=o.message.model.toLowerCase().includes("opus")?"opus":"sonnet");const d="opus"===l;c+=t*(d?15e-6:3e-6)+n*(d?75e-6:15e-6)+i*(d?1875e-8:375e-8)+r*(d?15e-7:3e-7),e.tokenBreakdown.input+=t,e.tokenBreakdown.output+=n,e.tokenBreakdown.cacheCreation+=i,e.tokenBreakdown.cacheRead+=r}"user"!==o.type&&"assistant"!==o.type||u++,o.timestamp&&(d=new Date(o.timestamp).toISOString().split("T")[0])}catch(e){}(a>0||u>0)&&(e.totalSessions++,e.totalMessages+=u,e.totalTokens+=a,e.totalCost+=c,"opus"===l?(e.byModel.opus.sessions++,e.byModel.opus.tokens+=a,e.byModel.opus.cost+=c):(e.byModel.sonnet.sessions++,e.byModel.sonnet.tokens+=a,e.byModel.sonnet.cost+=c),e.byDate[d]||(e.byDate[d]={sessions:0,messages:0,tokens:0,cost:0}),e.byDate[d].sessions++,e.byDate[d].messages+=2*n.length,e.byDate[d].tokens+=a,e.byDate[d].cost+=c,e.byProject[r]||(e.byProject[r]={sessions:0,messages:0,tokens:0,cost:0,lastUsed:Date.now()}),e.byProject[r].sessions++,e.byProject[r].messages+=u,e.byProject[r].tokens+=a,e.byProject[r].cost+=c)}catch(e){console.error(`Error processing session ${s}:`,e.message)}}}catch(e){console.error("Error reading projects directory:",e)}}console.log(`üìä Analytics loaded: ${e.totalSessions} sessions, ${e.totalTokens} tokens`),s.json(e)}catch(e){console.error("Error loading analytics:",e),s.status(500).json({error:"Failed to load analytics",details:e.message})}}),app.get("/claude-projects-quick",async(e,s)=>{try{const o=parseInt(e.query.limit)||20,t=parseInt(e.query.offset)||0;if(isWindows&&"native-windows"!==CLAUDE_EXECUTION_MODE){console.log("üîç Windows detected with WSL mode - loading projects from WSL");let e="user";try{const{execSync:s}=require("child_process");e=s('C:\\Windows\\System32\\wsl.exe -e bash -c "whoami"',{encoding:"utf8",windowsHide:!0}).trim()}catch(e){console.warn("Could not detect WSL user, using default")}const n=`/home/${e}/.claude/projects`;try{const{execFileSync:e}=require("child_process"),i="C:\\Windows\\System32\\wsl.exe",r=`cd "${n}" && for d in *; do [ -d "$d" ] && echo "$d"; done`;console.log("üìÇ Getting projects from WSL:",n);const a=e(i,["-e","bash","-c",r],{encoding:"utf8",windowsHide:!0}).trim();if(!a)return console.log("‚ùå No projects found in WSL"),s.json({projects:[],count:0});const c=a.split("\n").filter(e=>e.trim()).filter(e=>{const s=e.toLowerCase();return!(s.includes("temp")||s.includes("tmp")||s.includes("yurucode-server")||s.includes("yurucode-title-gen")||"-yurucode-title-gen"===s||s.includes("appdata")||s.includes("-mnt-c-users-")&&s.includes("-appdata-local-temp"))||(console.log(`üö´ Filtering out temp/server/title-gen directory: ${e}`),!1)}),l=[];for(const s of c){let o=0;try{const t=e(i,["-e","bash","-c",`cd ${n}/${s} && ls -t *.jsonl 2>/dev/null | head -1 | xargs -r stat -c %Y 2>/dev/null`],{encoding:"utf8",windowsHide:!0}).trim();t&&!isNaN(t)&&(o=1e3*parseInt(t))}catch(e){o=0}let t=0;try{const o=e(i,["-e","bash","-c",`ls -1 ${n}/"${s}"/*.jsonl 2>/dev/null | wc -l`],{encoding:"utf8",windowsHide:!0}).trim();t=parseInt(o)||0}catch(e){}0===t&&0===o||l.push({name:s,path:s,lastModified:o,sessionCount:t,sessions:[]})}l.sort((e,s)=>s.lastModified-e.lastModified),console.log(`‚úÖ Found ${l.length} projects in WSL`);const d=l.length,u=l.slice(t,t+o);return console.log(`üìÑ Returning ${u.length} projects (offset: ${t}, limit: ${o}, total: ${d})`),void s.json({projects:u,count:d})}catch(e){return console.error("‚ùå ERROR loading Windows projects:",e.message),console.error("Stack:",e.stack),s.json({projects:[],count:0})}}const n=join(homedir(),".claude","projects");if(isWindows&&"native-windows"===CLAUDE_EXECUTION_MODE?console.log("ü™ü Native Windows mode - loading projects from:",n):console.log("Quick loading project list from:",n),!existsSync(n))return console.log("Claude projects directory not found:",n),s.json({projects:[],count:0});const{readdir:i,stat:r}=await import("fs/promises"),a=(await i(n)).filter(e=>!e.startsWith(".")).map(async e=>{try{const s=join(n,e),o=await r(s);if(!o.isDirectory())return null;const t=(await i(s)).filter(e=>e.endsWith(".jsonl")).length;return{path:e,name:e,sessionCount:isWindows&&"native-windows"!==CLAUDE_EXECUTION_MODE&&0===t?null:t,lastModified:o.mtime.getTime()}}catch{return null}}),c=(await Promise.all(a)).filter(Boolean);c.sort((e,s)=>s.lastModified-e.lastModified);const l=c.length,d=c.slice(t,t+o);console.log(`Quick loaded ${d.length} of ${l} project names (offset: ${t}, limit: ${o})`),s.json({projects:d,count:l})}catch(e){console.error("Error quick loading projects:",e),s.status(500).json({error:"Failed to load projects",details:e.message})}}),app.get("/claude-project-sessions/:projectName",async(e,s)=>{try{const o=decodeURIComponent(e.params.projectName);if(console.log("üìÇ Loading sessions for project:",o),s.writeHead(200,{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}),isWindows&&"native-windows"!==CLAUDE_EXECUTION_MODE){let e="user";try{const{execSync:s}=require("child_process");e=s('C:\\Windows\\System32\\wsl.exe -e bash -c "whoami"',{encoding:"utf8",windowsHide:!0}).trim()}catch(e){console.warn("Could not detect WSL user, using default")}const t=`/home/${e}/.claude/projects/${o}`;console.log("üîç WSL mode - loading sessions from:",t);try{console.log("üöÄ Getting session list from WSL:",t);const{execFileSync:e}=require("child_process"),o=e("C:\\Windows\\System32\\wsl.exe",["-e","bash","-c",`cd "${t}" 2>/dev/null && for f in *.jsonl; do [ -f "$f" ] && stat -c "%Y:%n" -- "$f"; done | sort -rn | head -50`],{encoding:"utf8",windowsHide:!0}).trim();if(!o)return console.log("No sessions found"),s.write('data: {"done": true, "sessions": []}\n\n'),void s.end();const n=o.split("\n").filter(e=>e.trim()).map(e=>{const[s,o]=e.split(":");return{filename:o,timestamp:1e3*parseInt(s)}}).sort((e,s)=>s.timestamp-e.timestamp).slice(0,10);if(0===n.length)return console.log("No sessions found"),s.write('data: {"done": true, "sessions": []}\n\n'),void s.end();for(let o=0;o<n.length;o++){const{filename:i,timestamp:r}=n[o];try{if(o>=50)break;const a="C:\\Windows\\System32\\wsl.exe",c=e(a,["-e","bash","-c",`head -n1 "${t}/${i}" 2>/dev/null`],{encoding:"utf8",windowsHide:!0}).trim(),l=e(a,["-e","bash","-c",`tail -n1 "${t}/${i}" 2>/dev/null`],{encoding:"utf8",windowsHide:!0}).trim(),d=e(a,["-e","bash","-c",`head -n50 "${t}/${i}" 2>/dev/null | wc -l`],{encoding:"utf8",windowsHide:!0}).trim(),u=i.replace(".jsonl","");let g="Untitled session",m=null;try{const e=JSON.parse(l);("title"===e.type&&e.title||"metadata"===e.type&&e.title||e.title&&!e.role)&&(m=e.title)}catch(e){}if(!m)try{const e=JSON.parse(c);if(e.summary&&(g=e.summary,m||(m=e.summary)),e.title&&(m=e.title),!m&&"user"===e.role&&e.content)if("string"==typeof e.content)g=e.content.substring(0,100),m=g;else if(Array.isArray(e.content)){const s=e.content.find(e=>"text"===e.type);s&&s.text&&(g=s.text.substring(0,100),m=g)}"summary"===e.type&&e.summary&&(m=e.summary,g=e.summary)}catch(e){console.log(`Could not parse session title from: ${c}`)}const p={id:u,summary:g,title:m,timestamp:r,path:i,messageCount:parseInt(d)||0};s.write(`data: ${JSON.stringify({session:p,index:o,total:n.length})}\n\n`),console.log(`  üìÑ Sent session ${o+1}/${n.length}: ${u}`)}catch(e){console.log(`Error processing ${i}:`,e.message)}}s.write('data: {"done": true}\n\n'),console.log("‚úÖ Streamed all sessions"),s.end()}catch(e){console.error("Error loading sessions:",e.message),s.write('data: {"error": true, "message": "'+e.message+'"}\n\n'),s.end()}}else{const e=path.join(os.homedir(),".claude","projects",o);isWindows&&"native-windows"===CLAUDE_EXECUTION_MODE&&console.log("ü™ü Native Windows mode - loading sessions from:",e);try{if(!fs.existsSync(e))return console.log("Project directory not found:",e),s.write('data: {"done": true, "sessions": []}\n\n'),void s.end();const t=fs.readdirSync(e).filter(e=>e.endsWith(".jsonl")).map(s=>{const o=path.join(e,s);return{filename:s,fullPath:o,timestamp:fs.statSync(o).mtimeMs}}).sort((e,s)=>s.timestamp-e.timestamp);if(console.log(`Found ${t.length} sessions in project`),0===t.length)return s.write('data: {"done": true, "sessions": []}\n\n'),void s.end();for(let e=0;e<Math.min(t.length,50);e++){const{filename:n,fullPath:i,timestamp:r}=t[e];try{const a=fs.readFileSync(i,"utf8").split("\n")[0];if(!a)continue;const c=JSON.parse(a),l=c.uuid||n.replace(".jsonl",""),d={id:l,name:c.project_path||"Untitled",createdAt:new Date(r).toISOString(),messageCount:0,projectName:o};try{const e=fs.readFileSync(i,"utf8");d.messageCount=e.split("\n").filter(e=>e.trim()).length}catch(e){}s.write(`data: ${JSON.stringify({session:d,index:e,total:t.length})}\n\n`),console.log(`  üìÑ Sent session ${e+1}/${t.length}: ${l}`)}catch(e){console.log(`Error processing ${n}:`,e.message)}}s.write('data: {"done": true}\n\n'),console.log("‚úÖ Streamed all sessions"),s.end()}catch(e){console.error("Error loading sessions:",e.message),s.write('data: {"error": true, "message": "'+e.message+'"}\n\n'),s.end()}}}catch(e){console.error("Error loading project sessions:",e),s.write('data: {"error": true, "message": "Failed to load sessions"}\n\n'),s.end()}}),app.get("/claude-project-date/:projectName",async(e,s)=>{try{const o=decodeURIComponent(e.params.projectName);if(console.log(`üìÖ Getting date for project: ${o}`),isWindows&&"native-windows"!==CLAUDE_EXECUTION_MODE){let e="yuru";try{const{execSync:s}=require("child_process");e=s('powershell.exe -NoProfile -Command "& {wsl.exe whoami}"',{encoding:"utf8",windowsHide:!0}).trim()}catch(e){}const t=`powershell.exe -NoProfile -Command "& {wsl.exe -e bash -c 'cd ${`/home/${e}/.claude/projects/${o}`} && ls -t *.jsonl 2>/dev/null | head -1 | xargs -r stat -c %Y 2>/dev/null'}"`,{execSync:n}=require("child_process"),i=n(t,{encoding:"utf8",windowsHide:!0}).trim();let r=Date.now();if(i&&!isNaN(i)){r=1e3*parseInt(i);const e=new Date(r);console.log(`  ‚úÖ ${o}: ${e.toLocaleString()} (${i})`)}else console.log(`  ‚ö†Ô∏è ${o}: No sessions found, using current time`);s.json({projectName:o,lastModified:r})}else{const e=path.join(os.homedir(),".claude","projects",o);let t=Date.now();try{if(fs.existsSync(e)){t=fs.statSync(e).mtimeMs}}catch(e){console.log(`  ‚ö†Ô∏è ${o}: Error getting date, using current time`)}s.json({projectName:o,lastModified:t})}}catch(o){console.error("Error getting project date:",o),s.json({projectName:e.params.projectName,lastModified:Date.now()})}}),app.get("/claude-project-session-count/:projectName",async(e,s)=>{try{const o=decodeURIComponent(e.params.projectName);if(isWindows&&"native-windows"!==CLAUDE_EXECUTION_MODE){let e="user";try{const{execSync:s}=require("child_process");e=s('C:\\Windows\\System32\\wsl.exe -e bash -c "whoami"',{encoding:"utf8",windowsHide:!0}).trim()}catch(e){console.warn("Could not detect WSL user, using default")}const t=`/home/${e}/.claude/projects/${o}`;try{const{execSync:e}=require("child_process"),n=e(`powershell.exe -NoProfile -Command "& {wsl.exe -e bash -c 'ls -1 ${t}/*.jsonl 2>/dev/null | wc -l'}"`,{encoding:"utf8",windowsHide:!0}).trim(),i=parseInt(n)||0;s.json({projectName:o,sessionCount:i})}catch(e){s.json({projectName:o,sessionCount:0})}}else{const e=path.join(os.homedir(),".claude","projects"),t=path.join(e,o);try{const e=await fs.promises.readdir(t),n=e.filter(e=>e.endsWith(".jsonl")).length;console.log(`[Session Count] Project: ${o}, Count: ${n}`),s.json({projectName:o,sessionCount:n})}catch(e){console.error(`[Session Count] Error counting sessions for ${o}:`,e),s.json({projectName:o,sessionCount:0})}}}catch(e){s.status(500).json({error:"Failed to get session count"})}}),app.get("/claude-projects",async(e,s)=>{try{if(isWindows&&"native-windows"!==CLAUDE_EXECUTION_MODE){console.log("üö® WINDOWS DETECTED (WSL mode) - LOADING FROM WSL ONLY!");try{let e="yuru";try{const{execSync:s}=require("child_process");console.log("üîç Detecting WSL user via PowerShell...");const o='powershell.exe -NoProfile -Command "& {wsl.exe whoami}"';console.log("üíª PowerShell command:",o),e=s(o,{encoding:"utf8",windowsHide:!0}).trim(),console.log("‚úÖ WSL user found:",e)}catch(s){console.log("‚ö†Ô∏è Could not detect WSL user, using default:",e),console.log("  Error:",s.message)}const o=`/home/${e}/.claude/projects`;console.log("üìÇ WSL projects directory:",o),console.log("üîç WSL user detected:",e);const{execSync:t}=require("child_process");console.log("üîß Executing WSL command via PowerShell to list projects...");const n=`powershell.exe -NoProfile -Command "& {wsl.exe -e bash -c 'if [ -d ${o} ]; then ls -1 ${o}; else echo NO_PROJECTS_DIR; fi'}"`;console.log("üíª PowerShell command:",n);const i=t(n,{encoding:"utf8",windowsHide:!0}).trim();if(console.log("üìù Raw PowerShell/WSL output:",JSON.stringify(i)),!i||"NO_PROJECTS_DIR"===i||"ECHO is on."===i||i.includes("system cannot find"))return console.log("‚ùå No projects found or WSL error"),s.json({projects:[]});const r=i.split("\n").filter(e=>e&&!e.startsWith(".")&&"NO_DIR"!==e).filter(e=>{const s=e.toLowerCase();return!(s.includes("temp")||s.includes("tmp")||s.includes("yurucode-server")||s.includes("yurucode-title-gen")||"-yurucode-title-gen"===s||s.includes("appdata")||s.includes("-mnt-c-users-")&&s.includes("-appdata-local-temp"))||(console.log(`üö´ Filtering out temp/server/title-gen directory: ${e}`),!1)});console.log(`‚úÖ Found ${r.length} projects in WSL (after filtering):`,r);const a=[];for(const e of r){const s=`${o}/${e}`,n=[];try{const e=t(`powershell.exe -NoProfile -Command "& {wsl.exe -e bash -c 'find ${s} -name *.jsonl -type f -exec basename {} .jsonl \\\\; 2>/dev/null'}"`,{encoding:"utf8",windowsHide:!0,shell:!0}).trim();if(e){const o=e.split("\n").filter(e=>e);for(const e of o.slice(0,5)){const o=`${s}/${e}.jsonl`;let i="untitled session",r=0,a=Date.now();try{const e=t(`powershell.exe -NoProfile -Command "& {wsl.exe -e bash -c 'wc -l < ${o}'}"`,{encoding:"utf8",windowsHide:!0}).trim();r=parseInt(e)||0;const s=t(`powershell.exe -NoProfile -Command "& {wsl.exe -e bash -c 'head -n1 ${o}'}"`,{encoding:"utf8",windowsHide:!0}).trim();if(s)try{const e=JSON.parse(s);e.summary?i=e.summary:"user"===e.role&&e.content&&(i=e.content.slice(0,100),e.content.length>100&&(i+="..."))}catch(e){}const n=t(`powershell.exe -NoProfile -Command "& {wsl.exe -e bash -c 'stat -c %Y ${o}'}"`,{encoding:"utf8",windowsHide:!0}).trim();a=1e3*parseInt(n)||Date.now()}catch(e){}n.push({id:e,summary:i,timestamp:a,createdAt:a,path:o,messageCount:r})}}}catch(s){console.log(`Error loading sessions for ${e}:`,s.message)}n.length>0&&(n.sort((e,s)=>s.timestamp-e.timestamp),a.push({path:e,name:e,sessions:n,lastModified:n[0].timestamp,createdAt:Math.min(...n.map(e=>e.timestamp)),sessionCount:n.length,totalMessages:n.reduce((e,s)=>e+s.messageCount,0)}))}return a.sort((e,s)=>s.lastModified-e.lastModified),console.log(`‚úÖ Returning ${a.length} projects from WSL`),console.log("üìä Full projects data:",JSON.stringify(a,null,2).slice(0,500)),s.json({projects:a})}catch(e){return console.error("‚ùå ERROR loading WSL projects:",e.message),console.error("Stack:",e.stack),s.json({projects:[],count:0})}}const e=join(homedir(),".claude","projects");if(isWindows&&"native-windows"===CLAUDE_EXECUTION_MODE?console.log("ü™ü Native Windows mode - loading projects from:",e):console.log("Loading projects from:",e),console.log("Platform:",platform()),!existsSync(e))return console.log("Claude projects directory not found:",e),s.json({projects:[]});const{readdir:o,stat:t,readFile:n}=await import("fs/promises"),i=await o(e);console.log(`Found ${i.length} project directories`);const r=i.filter(e=>!e.startsWith(".")).map(async s=>{try{const i=join(e,s),r=await t(i);if(!r.isDirectory())return null;const a=(await o(i)).filter(e=>e.endsWith(".jsonl")).map(async e=>{try{const s=join(i,e),o=await t(s),r=e.replace(".jsonl","");let a="untitled session",c=0,l="";try{const e=(await n(s,"utf8")).split(/\r?\n/).filter(e=>e.trim());c=e.length;for(let s=0;s<Math.min(5,e.length);s++)try{const o=JSON.parse(e[s]);if(o.summary){a=o.summary;break}"user"===o.role&&o.content&&!l&&(l=o.content.slice(0,100))}catch{}"untitled session"===a&&l&&(a=l+(l.length>=100?"...":""))}catch(e){console.error("Error reading session file:",s,e)}return{id:r,summary:a,timestamp:o.mtime.getTime(),createdAt:o.birthtime?.getTime()||o.ctime?.getTime()||o.mtime.getTime(),path:s,messageCount:c}}catch(s){return console.error("Error processing session:",e,s),null}}),c=(await Promise.all(a)).filter(Boolean);if(0===c.length)return null;c.sort((e,s)=>s.timestamp-e.timestamp);const l=Math.min(...c.map(e=>e.createdAt||e.timestamp));return{path:s,name:s,sessions:c,lastModified:c[0]?.timestamp||r.mtime.getTime(),createdAt:l,sessionCount:c.length,totalMessages:c.reduce((e,s)=>e+(s.messageCount||0),0)}}catch(e){return console.error("Error processing project:",s,e),null}}),a=(await Promise.all(r)).filter(Boolean);a.sort((e,s)=>s.lastModified-e.lastModified),console.log(`Returning ${a.length} projects`),s.json({projects:a})}catch(e){console.error("Error loading projects:",e),s.status(500).json({error:"Failed to load projects",details:e.message})}});const pidFilePath=process.env.ELECTRON_RUN_AS_NODE?join(homedir(),`.yurucode-server-${PORT}.pid`):join(__dirname,`server-${PORT}.pid`);function writePidFile(){try{writeFileSync(pidFilePath,process.pid.toString()),console.log(`üìù Server PID ${process.pid} written to ${pidFilePath}`)}catch(e){console.log("‚ö†Ô∏è Could not write PID file (running from read-only location?):",e.message)}}function removePidFile(){try{fs.existsSync(pidFilePath)&&(fs.unlinkSync(pidFilePath),console.log("üóëÔ∏è Removed PID file"))}catch(e){}}function cleanupOldPidFiles(){try{const e=/^(\.yurucode-)?server-\d+\.pid$/,s=homedir();if(fs.existsSync(s)){fs.readdirSync(s).forEach(o=>{if(e.test(o)){const e=join(s,o);if(e!==pidFilePath)try{fs.unlinkSync(e),console.log(`üóëÔ∏è Cleaned up old PID file: ${o}`)}catch(e){}}})}const o=__dirname;if(fs.existsSync(o)){fs.readdirSync(o).forEach(s=>{if(e.test(s)){const e=join(o,s);if(e!==pidFilePath)try{fs.unlinkSync(e),console.log(`üóëÔ∏è Cleaned up old PID file: ${s}`)}catch(e){}}})}const t=process.env.TEMP||process.env.TMP||"/tmp",n=join(t,"yurucode-server");if(fs.existsSync(n)){fs.readdirSync(n).forEach(s=>{if(e.test(s)){const e=join(n,s);if(e!==pidFilePath)try{fs.unlinkSync(e),console.log(`üóëÔ∏è Cleaned up old PID file in temp: ${s}`)}catch(e){}}})}console.log("‚úÖ PID file cleanup complete")}catch(e){console.log("‚ö†Ô∏è PID file cleanup error:",e.message)}}process.on("SIGINT",()=>{console.log("\nüõë Server shutting down..."),removePidFile(),process.exit(0)}),process.on("SIGTERM",()=>{console.log("\nüõë Server terminated"),removePidFile(),process.exit(0)}),process.on("exit",()=>{removePidFile()}),process.on("uncaughtException",e=>{console.error("üí• Uncaught exception:",e),removePidFile(),process.exit(1)}),process.on("unhandledRejection",(e,s)=>{console.error("üí• Unhandled rejection at:",s,"reason:",e),removePidFile(),process.exit(1)}),io.on("connection",e=>{console.log("üîå Client connected:",e.id);let s=!0;const o=new Map;function t(){if(processSpawnQueue.length>0){const e=processSpawnQueue.shift();console.log(`üîÑ Processing next spawn request. Remaining in queue: ${processSpawnQueue.length}`),e()}}e.on("claude-settings-update",e=>{console.log("üîÑ Received Claude settings update:",e.settings?.executionMode),e.settings&&(CLAUDE_EXECUTION_MODE=e.settings.executionMode||"auto",e.detection?.nativeWindows?.path&&(NATIVE_WINDOWS_CLAUDE_PATH=e.detection.nativeWindows.path),e.detection?.wsl?.path&&(WSL_CLAUDE_PATH=e.detection.wsl.path),console.log("‚úÖ Claude settings updated successfully"))}),e.on("createSession",async(s,o)=>{try{let t,n=null,i=[],r=null;s.existingSessionId&&s.messages?(t=s.existingSessionId,r=sessions.get(t),r?.wasCompacted?(n=null,console.log(`üìÇ Loading compacted session: ${t} - ignoring old Claude ID`)):(n=s.claudeSessionId||null,console.log(`üìÇ Loading existing session: ${t} with Claude ID: ${n}`)),i=s.messages||[],console.log(`üìù Loaded ${i.length} existing messages`)):(t=`session-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,console.log(`‚ú® Creating new session: ${t}`));let a=s.workingDirectory;if(a&&isWindows&&"native-windows"===CLAUDE_EXECUTION_MODE&&NATIVE_WINDOWS_CLAUDE_PATH){const e=a;a=wslToWindowsPath(a),e!==a&&console.log(`üîÑ [Session Creation] Converted WSL path to Windows path: ${e} ‚Üí ${a}`)}if(a){const e=a.toLowerCase();(e.includes("\\temp\\")||e.includes("/temp/")||e.includes("\\tmp\\")||e.includes("/tmp/")||e.includes("appdata\\local\\temp")||e.includes("yurucode-server"))&&(console.log(`üö´ Rejecting temp directory as working directory: ${a}`),a=null)}a||(a=homedir(),console.log(`üìÇ Using home directory as fallback: ${a}`));const c={id:t,name:s.name||"new session",socketId:e.id,workingDirectory:a,messages:i,createdAt:Date.now(),claudeSessionId:n,interruptedSessionId:null,hasGeneratedTitle:i.length>0,wasInterrupted:!1,wasCompacted:r?.wasCompacted||!1};sessions.set(t,c),console.log(`‚úÖ Session ready: ${t}`),console.log(`üìÅ Working directory: ${a}`),o&&o({success:!0,sessionId:t,workingDirectory:a})}catch(e){console.error("‚ùå Error creating session:",e),o&&o({success:!1,error:e.message})}}),e.on("sendMessage",async(n,i)=>{console.log("üì® [sendMessage] Processing message in EMBEDDED SERVER");const{sessionId:r,content:a,autoGenerateTitle:c,systemPromptSettings:l}=n;let{model:d}=n;const u=sessions.get(r);if(!u)return console.error(`‚ùå Session not found: ${r}`),void(i&&i({success:!1,error:"Session not found"}));if(a&&"/test"===a.trim()){console.log("üß™ [TEST] Test command received"),e.emit(`message:${r}`,{type:"user",message:{content:a},timestamp:Date.now()});const s=`test-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return e.emit(`message:${r}`,{id:s,type:"assistant",message:{content:[{type:"text",text:"‚úÖ test command works!\n\nyurucode is running properly."}]},streaming:!1,timestamp:Date.now()}),u.claudeSessionId&&u.claudeSessionId!==r&&e.emit(`message:${u.claudeSessionId}`,{id:s,type:"assistant",message:{content:[{type:"text",text:"‚úÖ test command works!\n\nyurucode is running properly."}]},streaming:!1,timestamp:Date.now()}),void(i&&i({success:!0}))}if(a&&a.startsWith("$")){console.log(`üêö [BASH] Detected bash command: ${a}`);let s=a.substring(1).trim();console.log(`üêö [BASH] Extracted command: ${s}`);const{spawn:o}=require("child_process"),t=`bash-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;try{e.emit(`message:${r}`,{type:"user",message:{content:a},timestamp:Date.now()}),console.log(`üêö [BASH] Started streaming with message ID: ${t}`);const n=u.workingDirectory||require("os").homedir();if(console.log(`üêö [BASH] Working directory: ${n}`),"win32"===process.platform){let a;activeBashProcesses.set(r,null);const c=!1;c?(console.log(`üêö [CMD] Running Windows command: ${s}`),console.log(`üêö [CMD] Working directory: ${n}`),a=o("cmd.exe",["/C",s],{cwd:n,windowsHide:!0,detached:!1,shell:!1,stdio:["ignore","pipe","pipe"]}),console.log("üêö [CMD] Process spawned"),activeBashProcesses.set(r,a)):(console.log(`üêö [POWERSHELL] Running command: ${s}`),console.log(`üêö [POWERSHELL] Working directory: ${n}`),a=o("powershell.exe",["-NoProfile","-NonInteractive","-Command",s],{cwd:n,windowsHide:!0,detached:!1,shell:!1,stdio:["ignore","pipe","pipe"]}),console.log("üêö [POWERSHELL] Process spawned"),activeBashProcesses.set(r,a));let l="",d="";a.stdout.on("data",e=>{const s=e.toString();l+=s;const o=c?"[CMD]":"[BASH]";console.log(`üêö ${o} stdout chunk (${s.length} bytes)`)}),a.stderr.on("data",e=>{const s=e.toString();d+=s;const o=c?"[CMD]":"[BASH]";console.log(`üêö ${o} stderr chunk (${s.length} bytes)`)}),a.on("close",s=>{const o=c?"[CMD]":"[BASH]";console.log(`üêö ${o} Process exited with code ${s}`),console.log(`üêö ${o} Total output: ${l.length} bytes stdout, ${d.length} bytes stderr`),console.log(`üêö ${o} Sending streaming: false to clear thinking state`),activeBashProcesses.delete(r);let n="";0!==s?d?(n=`‚ùå Command failed with exit code ${s}\n\nError output:\n${d}`,l&&(n+=`\n\nStandard output:\n${l}`)):n=l?`‚ùå Command failed with exit code ${s}\n\n${l}`:`‚ùå Command failed with exit code ${s} (no output)`:n=l||d||"(no output)";const a={id:t,type:"assistant",message:{content:[{type:"text",text:`\`\`\`ansi\n${n}\n\`\`\``}]},streaming:!1,timestamp:Date.now()};console.log(`üêö ${o} SessionId:`,r),console.log(`üêö ${o} Emitting result on channel: message:${r}`),console.log(`üêö ${o} Result message:`,JSON.stringify(a).substring(0,500)),e.emit(`message:${r}`,a),u.claudeSessionId&&u.claudeSessionId!==r&&(console.log(`üêö ${o} Also emitting to Claude session: message:${u.claudeSessionId}`),e.emit(`message:${u.claudeSessionId}`,a)),setTimeout(()=>{console.log(`üêö ${o} Sending explicit stream end signal`),e.emit(`message:${r}`,{type:"system",subtype:"stream_end",streaming:!1,timestamp:Date.now()}),u.claudeSessionId&&u.claudeSessionId!==r&&e.emit(`message:${u.claudeSessionId}`,{type:"system",subtype:"stream_end",streaming:!1,timestamp:Date.now()})},100),i&&i({success:!0})}),a.on("exit",(e,s)=>{const o=c?"[CMD]":"[BASH]";console.log(`üêö ${o} Process EXIT event: code=${e}, signal=${s}`)}),a.on("error",s=>{const o=c?"[CMD]":"[BASH]";console.error(`üêö ${o} Process error: ${s.message}`),console.log(`üêö ${o} Sending streaming: false due to error`),e.emit(`message:${r}`,{type:"assistant",message:{content:[{type:"text",text:`\`\`\`\nError: ${s.message}\n\`\`\``}]},streaming:!1,timestamp:Date.now()}),i&&i({success:!1,error:s.message})})}else{console.log(`üêö [BASH] Unix command: ${s}`),console.log(`üêö [BASH] Using bashMessageId: ${t}`);const a=o("bash",["-c",s],{cwd:n,stdio:["ignore","pipe","pipe"]});activeBashProcesses.set(r,a);let c="",l="",d=!1;a.stdout.on("data",e=>{c+=e.toString(),console.log(`üêö [BASH] stdout received: ${e.toString().length} bytes`)}),a.stderr.on("data",e=>{l+=e.toString(),console.log(`üêö [BASH] stderr received: ${e.toString().length} bytes`)}),a.on("close",s=>{if(d)return void console.log("üêö [BASH] Ignoring duplicate close event");d=!0,activeBashProcesses.delete(r),console.log(`üêö [BASH] Unix process exited with code ${s}`),console.log(`üêö [BASH] Total output: ${c.length} bytes stdout, ${l.length} bytes stderr`),console.log(`üêö [BASH] Sending result with bashMessageId: ${t}`);let o="";0!==s?l?(o=`‚ùå Command failed with exit code ${s}\n\nError output:\n${l}`,c&&(o+=`\n\nStandard output:\n${c}`)):o=c?`‚ùå Command failed with exit code ${s}\n\n${c}`:`‚ùå Command failed with exit code ${s} (no output)`:o=c||l||"(no output)";const n={id:t,type:"assistant",message:{content:[{type:"text",text:`\`\`\`ansi\n${o}\n\`\`\``}]},streaming:!1,timestamp:Date.now()};e.emit(`message:${r}`,n),i&&i({success:!0})}),a.on("error",s=>{d||(d=!0,console.error(`üêö [BASH] Unix process error: ${s.message}`),e.emit(`message:${r}`,{id:t,type:"assistant",message:{content:[{type:"text",text:`\`\`\`\nError: ${s.message}\n\`\`\``}]},streaming:!1,timestamp:Date.now()}),i&&i({success:!1,error:s.message}))})}}catch(s){console.error(`üêö [BASH] Failed to spawn: ${s.message}`),e.emit(`message:${r}`,{type:"assistant",message:{content:[{type:"text",text:`\`\`\`\nFailed to execute: ${s.message}\n\`\`\``}]},streaming:!1,timestamp:Date.now()}),i&&i({success:!1,error:s.message})}return}console.log(`[${r}] Using model: ${d} (type: ${typeof d})`);const g=async()=>{try{if(console.log("\nüì® Processing message request:",{sessionId:r,messageLength:a?.length||0,model:d,queueLength:processSpawnQueue.length}),stoppedSessions.get(r)&&(console.log(`üîÑ [${r}] Clearing stopped flag for new message`),stoppedSessions.delete(r)),spawningProcesses.has(r)){const s=spawningProcesses.get(r),o=Date.now()-s.startTime;return console.log(`‚è≥ [${r}] Process is currently spawning (${o}ms ago) - queueing message`),e.emit(`message:${r}`,{type:"system",subtype:"info",message:"processing previous message, will send yours next...",timestamp:Date.now()}),void setTimeout(()=>{processSpawnQueue.push(g),t()},1500)}if(activeProcesses.has(r)){const s=activeProcesses.get(r),o=activeProcessStartTimes.get(r)||Date.now(),n=Date.now()-o;if(n<3e3)return console.log(`‚è≥ Process for session ${r} is only ${n}ms old, queueing message instead of killing`),e.emit(`message:${r}`,{type:"system",subtype:"info",message:"processing previous message, will send yours next...",timestamp:Date.now()}),void setTimeout(()=>{processSpawnQueue.push(g),t()},2e3);if(console.log(`‚ö†Ô∏è Killing existing process for session ${r} (PID: ${s.pid}, age: ${n}ms)`),"win32"!==process.platform&&s.pid)try{process.kill(-s.pid,"SIGINT")}catch(e){s.kill("SIGINT")}else s.kill("SIGINT");activeProcesses.delete(r),activeProcessStartTimes.delete(r),u.wasInterrupted=!0,console.log(`üîÑ Marked session ${r} as interrupted (keeping claudeSessionId: ${u.claudeSessionId} for resume)`),await new Promise(e=>setTimeout(e,500))}let n=u.workingDirectory;if(n){const e=n.toLowerCase();(e.includes("\\temp\\")||e.includes("/temp/")||e.includes("\\tmp\\")||e.includes("/tmp/")||e.includes("appdata\\local\\temp")||e.includes("yurucode-server"))&&(console.log(`üö´ Session has temp directory, using home instead: ${n}`),n=null)}if(console.log(`üîç Path conversion check:\n          - processWorkingDir: ${n}\n          - isWindows: ${isWindows}\n          - CLAUDE_EXECUTION_MODE: ${CLAUDE_EXECUTION_MODE}\n          - NATIVE_WINDOWS_CLAUDE_PATH: ${NATIVE_WINDOWS_CLAUDE_PATH}`),n&&isWindows&&"native-windows"===CLAUDE_EXECUTION_MODE&&NATIVE_WINDOWS_CLAUDE_PATH){const e=n;n=wslToWindowsPath(n),e!==n?console.log(`üîÑ Converted WSL path to Windows path: ${e} ‚Üí ${n}`):console.log(`‚ÑπÔ∏è Path unchanged (not WSL format): ${n}`)}else console.log("‚è≠Ô∏è Skipping path conversion (conditions not met)");n?console.log(`üìÇ Using working directory: ${n}`):(n=homedir(),console.log(`üìÇ Using home directory as fallback: ${n}`));const m=["--print","--output-format","stream-json","--verbose","--dangerously-skip-permissions","--disallowed-tools","AskUserQuestion,EnterPlanMode,ExitPlanMode"],p=l||{},h="you are in yurucode ui. prefer lowercase, be extremely concise, never use formal language, no greetings or pleasantries, straight to the point. you must plan first - use think and todo as much as possible to break down everything, including planning into multiple steps and do edits in small chunks";if(!1!==p.enabled){let e="";e="custom"===p.mode&&p.customPrompt?p.customPrompt:("preset"===p.mode&&p.selectedPreset,h),e&&(m.push("--append-system-prompt"),m.push(e),console.log(`üéØ [${r}] Using system prompt mode: ${p.mode||"default"} (${e.length} chars)`))}else console.log(`üéØ [${r}] System prompt disabled`);const f=u.totalTokens||0,w=2e5;f>=194e3&&!u.isCompacting&&"/compact"!==a.trim()&&(console.log(`‚ö†Ô∏è Auto-compact triggered: ${f}/${w} tokens (${Math.round(f/w*100)}%)`),e.emit(`message:${r}`,{type:"system",subtype:"info",message:{content:`üìä Context nearly full (${Math.round(f/w*100)}%). Auto-compacting conversation...`},timestamp:Date.now()}),y="/compact");let y=a;const $=y?.match(/^\/compact\s*(.*)?$/i);if($){const s=$[1]?.trim()||null;if(console.log("üóúÔ∏è Custom /compact triggered - will use Sonnet to self-summarize"),s&&console.log(`üóúÔ∏è Custom instructions: "${s}"`),d="claude-sonnet-4-5-20250929",console.log(`üóúÔ∏è Using Sonnet 4.5 for compact operation: ${d}`),!u.claudeSessionId)return console.log("‚ö†Ô∏è No active session to compact"),e.emit(`message:${r}`,{type:"system",subtype:"error",message:{content:"No active conversation to compact. Start a conversation first."},timestamp:Date.now()}),processSpawnQueue.shift(),isSpawningProcess=!1,void(processSpawnQueue.length>0&&processNextSpawnRequest());let o="Please provide a detailed summary of our entire conversation so far. Include:\n1. Key facts about me (name, project details, preferences)\n2. Main topics we've discussed\n3. Any code or solutions we've worked on\n4. Important decisions or conclusions\n5. Current task/problem we're addressing\n6. Any context needed to continue our work\n\nFormat as a clear, structured summary that preserves all important context.";s&&(o+=`\n\nAdditional instructions for the summary:\n${s}`),console.log(`üóúÔ∏è Asking Claude to self-summarize with session ${u.claudeSessionId}`),y=o,u.isCompacting=!0;const t=void 0!==getWrapperSession?getWrapperSession(r):null;console.log("üóúÔ∏è Wrapper session state:",t?{totalTokens:t.totalTokens,inputTokens:t.inputTokens,outputTokens:t.outputTokens}:"not available"),console.log(`üóúÔ∏è Session token state: totalTokens=${u.totalTokens}`),u.compactStartTokens=t?.totalTokens||u.totalTokens||0,u.compactMessageCount=u.messages?.length||0,u.compactCustomInstructions=s,console.log(`üóúÔ∏è Set compactStartTokens to ${u.compactStartTokens}`)}d&&(m.push("--model",d),console.log(`ü§ñ Using model: ${d}`));let S=!1;if(!u.claudeSessionId&&u.interruptedSessionId&&u.wasInterrupted&&(console.log(`üîÑ Restoring interrupted session: ${u.interruptedSessionId}`),u.claudeSessionId=u.interruptedSessionId,u.interruptedSessionId=null),S=u.claudeSessionId,S)m.push("--resume",u.claudeSessionId),console.log("üîÑ Using --resume flag with session:",u.claudeSessionId),u.wasInterrupted&&(console.log("üìù Resuming after interrupt"),u.wasInterrupted=!1);else if(u.wasCompacted&&u.compactSummary){console.log("üìù Starting fresh conversation after compaction"),console.log(`üóúÔ∏è Previous conversation was compacted, saved ${u.tokensSavedByCompact||0} tokens`),console.log("üóúÔ∏è Injecting summary into new conversation");y=`[Previous conversation context - compacted from ${u.tokensSavedByCompact} tokens]:\n${u.compactSummary}\n\n[Continuing conversation]\nUser: ${y}`,u.wasCompacted=!1,u.compactSummary=null,console.log(`üóúÔ∏è Message with context: ${a.substring(0,200)}...`)}else console.log("üìù Starting fresh conversation (no previous session)");console.log("üöÄ Spawning claude with args:",m),console.log(`üîç Active processes count: ${activeProcesses.size}`);const C={...process.env};if(isWindows&&"native-windows"===CLAUDE_EXECUTION_MODE&&NATIVE_WINDOWS_CLAUDE_PATH){C.SHELL="C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",C.COMSPEC=process.env.COMSPEC||"C:\\Windows\\System32\\cmd.exe",console.log("üîß Set SHELL to PowerShell for Windows native mode");const e=["C:\\Program Files\\nodejs","C:\\Program Files (x86)\\nodejs",process.env.ProgramFiles&&`${process.env.ProgramFiles}\\nodejs`,process.env.LOCALAPPDATA&&`${process.env.LOCALAPPDATA}\\Programs\\nodejs`].filter(Boolean);for(const s of e)if(existsSync(s)&&!C.PATH?.includes(s)){C.PATH=`${s};${C.PATH||""}`,console.log(`üîß Added Node.js to PATH: ${s}`);break}}else if(!isWindows){const e="/opt/homebrew/bin";C.PATH?.includes(e)||(C.PATH=`${e}:${C.PATH||"/usr/bin:/bin"}`,console.log(`üîß Added ${e} to PATH for Claude CLI`))}if(C.CLAUDE_SESSION_ID=r,C.CLAUDE_INSTANCE=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,isSpawningProcess&&(console.log("‚è≥ Waiting for previous Claude process to initialize..."),await new Promise(e=>setTimeout(e,200))),isSpawningProcess=!0,spawningProcesses.set(r,{startTime:Date.now(),aborted:!1}),console.log(`üîÑ Session ${r} marked as spawning`),n&&isWindows&&"native-windows"===CLAUDE_EXECUTION_MODE&&NATIVE_WINDOWS_CLAUDE_PATH){const e=n,s=wslToWindowsPath(n);e!==s&&(console.log(`üîÑ Converting WSL path for validation: ${e} ‚Üí ${s}`),n=s)}C.PWD=n,C.HOME=homedir(),console.log(`üîß Set PWD=${n} and HOME=${homedir()} in environment`),existsSync(n)||(console.warn(`‚ö†Ô∏è Working directory does not exist: ${n}, using home directory`),n=homedir());const k={cwd:n,env:C,shell:!1,windowsHide:!0,detached:!1,stdio:["pipe","pipe","pipe"]};let T;console.log("üöÄ Spawning claude process with options:",{cwd:k.cwd,claudePath:CLAUDE_PATH,args:m});let P=null;if(isWindows){let e=n,s=y;if(u.pendingContextRestore&&u.messages&&u.messages.length>0){console.log("üîÑ Building context for WSL command");let e="Here's our previous conversation context:\\n\\n";const o=u.messages.slice(-10);for(const s of o)if("user"===s.type){const o=s.message?.content||"";let t="";"string"==typeof o?t=o:Array.isArray(o)&&(t=o.filter(e=>"text"===e.type).map(e=>e.text).join("")),e+=`User: ${t.substring(0,200)}${t.length>200?"...":""}\\n\\n`}else if("assistant"===s.type){const o=s.message?.content||"";let t="";"string"==typeof o?t=o:Array.isArray(o)&&(t=o.filter(e=>"text"===e.type).map(e=>e.text).join("")),e+=`Assistant: ${t.substring(0,200)}${t.length>200?"...":""}\\n\\n`}e+=`---\\nNow, continuing our conversation: ${y}`,s=e,u.pendingContextRestore=!1}const[o,t,i,r]=getClaudeCommand(m,e,s);if(P=r,console.log(`üöÄ Running command: ${o}`),console.log("üöÄ Args (first 500 chars):",JSON.stringify(t).substring(0,500)),console.log(`üöÄ Input handled: ${i}`),o.includes("wsl.exe")&&!existsSync(o))throw console.error(`‚ùå WSL.exe not found at: ${o}`),console.error("‚ùå Please ensure WSL is installed on Windows"),new Error("WSL.exe not found. Please install Windows Subsystem for Linux.");if((o.endsWith(".cmd")||o.endsWith(".bat"))&&!o.endsWith("node.exe")){k.shell=!0;const e=["C:\\Program Files\\nodejs","C:\\Program Files (x86)\\nodejs",process.env.ProgramFiles+"\\nodejs"].filter(Boolean);for(const s of e)if(existsSync(s)){k.env={...k.env},k.env.PATH=s+";"+(k.env.PATH||process.env.PATH),console.log(`‚úÖ Added Node.js to PATH for .cmd execution: ${s}`);break}}T=spawn(o,t,k),T.inputHandled=i}else T=spawn(CLAUDE_PATH,m,k);setTimeout(()=>{isSpawningProcess=!1},500),activeProcesses.set(r,T),activeProcessStartTimes.set(r,Date.now()),cancelPendingStreamingFalse(r);const I=spawningProcesses.get(r);if(spawningProcesses.delete(r),console.log(`‚úÖ Session ${r} spawn complete, process registered (PID: ${T.pid})`),I?.aborted||pendingInterrupts.has(r)){console.log(`üõë Session ${r} was interrupted during spawn - killing immediately`);const s=pendingInterrupts.get(r);pendingInterrupts.delete(r);if("win32"===process.platform&&T.pid){try{require("child_process").execSync(`taskkill /F /T /PID ${T.pid}`,{stdio:"ignore",timeout:5e3})}catch(e){}try{T.kill()}catch(e){}}else if(T.pid)try{process.kill(-T.pid,"SIGINT")}catch(e){T.kill("SIGINT")}return activeProcesses.delete(r),activeProcessStartTimes.delete(r),s&&s({success:!0,killedDuringSpawn:!0}),void e.emit(`message:${r}`,{type:"system",subtype:"interrupted",message:"task interrupted by user",timestamp:Date.now()})}if("win32"!==process.platform&&T.unref(),u.pendingContextRestore&&u.messages&&u.messages.length>0){console.log(`üîÑ Restoring context with ${u.messages.length} previous messages`);let e="Here's our previous conversation context:\n\n";const s=u.messages.slice(-10);for(const o of s)if("user"===o.type){const s=o.message?.content||"";let t="";"string"==typeof s?t=s:Array.isArray(s)&&(t=s.filter(e=>"text"===e.type).map(e=>e.text).join("")),e+=`User: ${t.substring(0,200)}${t.length>200?"...":""}\n\n`}else if("assistant"===o.type){const s=o.message?.content||"";let t="";"string"==typeof s?t=s:Array.isArray(s)&&(t=s.filter(e=>"text"===e.type).map(e=>e.text).join("")),e+=`Assistant: ${t.substring(0,200)}${t.length>200?"...":""}\n\n`}e+=`---\nNow, continuing our conversation: ${a}`;const o=e+"\n";if(console.log(`üìù Sending context + message to claude (${o.length} chars)`),!T.inputHandled){const e=setTimeout(()=>{console.error("‚ö†Ô∏è Stdin write timeout - forcing close");try{T.stdin.end(),T.stdin.destroy()}catch(e){console.error(`Failed to force close stdin: ${e.message}`)}},1e4);T.stdin.write(o,s=>{clearTimeout(e),s?console.error("‚ùå Error writing to stdin:",s):console.log("‚úÖ Successfully sent context restoration"),T.stdin.end(),console.log("üìù Closed stdin after sending message (--print mode requires this)")})}u.pendingContextRestore=!1}else if(a&&!T.inputHandled){const e=y+"\n";console.log(`üìù Sending message to claude via stdin (${y.length} chars) - resuming=${S}`);const s=setTimeout(()=>{console.error("‚ö†Ô∏è Stdin write timeout - forcing close");try{T.stdin.end(),T.stdin.destroy()}catch(e){console.error(`Failed to force close stdin: ${e.message}`)}},1e4);T.stdin.write(e,e=>{clearTimeout(s),e?console.error("‚ùå Error writing to stdin:",e):console.log("‚úÖ Successfully wrote to stdin"),T.stdin.end(),console.log("üìù Closed stdin after sending message (--print mode requires this)")})}else if(T.inputHandled){if(console.log("üìù Message already embedded in command (WSL or temp file)"),P&&"native-windows"===CLAUDE_EXECUTION_MODE){const e=require("fs");try{const s=e.readFileSync(P,"utf8");console.log(`üìù Piping temp file content to stdin (${s.length} chars)`),T.stdin.write(s),T.stdin.end(),setTimeout(()=>{try{e.unlinkSync(P),console.log(`üóëÔ∏è Cleaned up temp file: ${P}`)}catch(e){}},1e3)}catch(e){console.error(`‚ùå Failed to read temp file: ${e.message}`)}}}else a||console.log("üìù No message to send");if(console.log(`üè∑Ô∏è Title check: hasGeneratedTitle=${u.hasGeneratedTitle}, messageLength=${a?.length}, autoGenerateTitle=${c}`),c&&!u.hasGeneratedTitle&&a&&a.length>5){let s=a;try{const e=JSON.parse(a);if(Array.isArray(e)){s=e.filter(e=>"text"===e.type).map(e=>e.text).join(" "),console.log(`üè∑Ô∏è Extracted text from JSON: "${s}"`)}}catch(e){console.log(`üè∑Ô∏è Using plain text content: "${s}"`)}s&&s.trim().length>5?(console.log(`üè∑Ô∏è Calling generateTitle for session ${r}`),generateTitle(r,s,e,()=>{console.log(`üè∑Ô∏è Title successfully generated for session ${r}`),u.hasGeneratedTitle=!0})):console.log(`üè∑Ô∏è Skipping title generation - text too short: "${s}"`)}let E="",_=0,A=0,D=Date.now(),v=Date.now(),b={timer:null};streamHealthChecks.has(r)&&clearInterval(streamHealthChecks.get(r)),streamTimeouts.has(r)&&clearTimeout(streamTimeouts.get(r));const x=setInterval(()=>{const s=Date.now()-D,o=Date.now()-v;console.log(`ü©∫ [${r}] duration: ${o}ms | since_last: ${s}ms | bytes: ${A} | msgs: ${_} | buffer: ${E.length} | alive: ${activeProcesses.has(r)}`),s>6e4&&s<65e3&&(console.log("‚è≥ No data for 1 min - Claude processing complex task..."),e.emit(`keepalive:${r}`,{timestamp:Date.now(),info:"Processing complex task",elapsed:s})),s>3e5&&s<305e3&&(console.warn("‚ö†Ô∏è No data for 5 min - task taking longer than usual"),e.emit(`keepalive:${r}`,{timestamp:Date.now(),warning:"Long-running operation in progress",elapsed:s})),s>48e4&&s<485e3&&(console.error("üö® No data for 8 min - may be frozen"),e.emit(`message:${r}`,{type:"system",subtype:"warning",content:"‚ö†Ô∏è Claude has been silent for 8 minutes. Will terminate at 10 minutes if no response.",timestamp:Date.now()}))},5e3);streamHealthChecks.set(r,x);const j=()=>{b.timer&&clearTimeout(b.timer),b.timer=setTimeout(()=>{const s=Date.now()-D;if(console.error(`üêï WATCHDOG: Killing frozen process after ${s}ms of no data`),activeBashProcesses.has(r)){const e=activeBashProcesses.get(r);if(e){try{e.kill("SIGKILL")}catch(e){}activeBashProcesses.delete(r)}}if(activeProcesses.has(r)){const e=activeProcesses.get(r);try{e.kill("SIGKILL")}catch(e){}activeProcesses.delete(r),activeProcessStartTimes.delete(r)}e.emit(`message:${r}`,{type:"system",subtype:"error",content:"üî¥ Watchdog timer: Claude was terminated due to unresponsiveness",timestamp:Date.now()}),streamHealthChecks.has(r)&&(clearInterval(streamHealthChecks.get(r)),streamHealthChecks.delete(r)),streamTimeouts.has(r)&&(clearTimeout(streamTimeouts.get(r)),streamTimeouts.delete(r))},66e4)};j();const W=setTimeout(()=>{if(console.warn(`‚è∞ Stream timeout reached for session ${r} after 45 minutes`),activeProcesses.has(r)){const e=activeProcesses.get(r);console.log(`‚è∞ Terminating long-running process for ${r}`),e.kill("SIGTERM")}},27e5);streamTimeouts.set(r,W);const L=t=>{if(t.trim())if(T&&T.pid&&killedProcessPIDs.has(T.pid))console.log(`üõë [${r}] Process ${T.pid} was killed - ignoring buffered line`);else if(stoppedSessions.get(r))console.log(`üõë [${r}] Session stopped - ignoring buffered line`);else{try{const e=processWrapperLine(t,r);e&&e!==t&&(t=e)}catch(e){console.error("[WRAPPER] Error processing line:",e.message)}if(D=Date.now(),j(),t.includes("No conversation found with session ID")){console.log(`üîÑ [${r}] Resume failed - session not found in Claude storage`),console.log(`üîÑ [${r}] KILLING process and clearing state`),stoppedSessions.set(r,!0),console.log(`üõë [${r}] Marked session as stopped - buffered data will be ignored`);try{if(T&&!T.killed){const e=T.pid;console.log(`üõë [${r}] Killing claude process PID: ${e}`),e&&(killedProcessPIDs.add(e),console.log(`üõë [${r}] Added PID ${e} to killed set`)),T.kill("SIGTERM"),activeProcesses.delete(r),activeProcessStartTimes.delete(r)}}catch(e){console.error(`‚ùå [${r}] Error killing process:`,e.message)}const s=lastAssistantMessageIds.get(r);s&&(console.log(`üî¥ [${r}] Clearing streaming for message ${s}`),e.emit(`update:${r}`,{id:s,streaming:!1}),lastAssistantMessageIds.delete(r)),e.emit(`message:${r}`,{type:"system",subtype:"stream_end",streaming:!1,timestamp:Date.now()});const o=sessions.get(r);if(o){o.claudeSessionId=null;const s=`system-info-${Date.now()}-${Math.random()}`;e.emit(`message:${r}`,{id:s,type:"system",subtype:"info",message:{content:"session expired - send message again to continue"},timestamp:Date.now(),streaming:!1}),console.log(`üì§ [${r}] Sent info message ${s} about session expiry`),o.isReady=!0,console.log(`‚úÖ [${r}] Session marked as ready after resume failure`)}return}try{const n=JSON.parse(t),i=u?.messages?.filter(e=>"user"===e.role).pop(),a="/compact"===i?.message?.content?.trim();a&&n.type;if(n.session_id&&!a){const e=u.claudeSessionId;if(e&&e!==n.session_id){const s=getWrapperSession(r),o=s.accumulatedTotalTokens;s.totalTokens=0,s.inputTokens=0,s.outputTokens=0,s.cacheCreationTokens=0,s.cacheReadTokens=0,s.accumulatedInputTokens=0,s.accumulatedOutputTokens=0,s.accumulatedTotalTokens=0,s.accumulatedCacheRead=0,s.accumulatedCacheCreation=0,console.log(`üîÑ [${r}] NEW Claude session detected (${e} ‚Üí ${n.session_id})`),console.log(`üîÑ [${r}] Reset wrapper tokens: ${o} ‚Üí 0 (each session has independent 200k limit)`)}u.claudeSessionId=n.session_id,console.log(`üìå [${r}] Claude session ID: ${u.claudeSessionId}`)}else a&&n.session_id&&console.log(`üóúÔ∏è [${r}] Ignoring session ID during compact: ${n.session_id} (not resumable)`);if("system"===n.type&&"init"===n.subtype)e.emit(`message:${r}`,{type:"system",subtype:"init",message:n,timestamp:Date.now()});else if("assistant"===n.type){const t=`assistant-${r}-${Date.now()}-${Math.random()}`;if(n.message?.content){let i=!1,a=[],c=!1;for(const t of n.message.content)if("text"===t.type||"thinking"===t.type)i=!0,a.push(t),"thinking"===t.type&&console.log(`üß† [${r}] Found thinking block: ${(t.thinking||t.text||"").substring(0,100)}...`);else if("tool_use"===t.type){c=!0,"Bash"===t.name&&s&&(console.log(`üîß [${r}] Tracking first Bash tool use: ${t.id}`),o.set(t.id,{sessionId:r,timestamp:Date.now()}));const i={type:"tool_use",message:{name:t.name,input:t.input,id:t.id},timestamp:Date.now(),id:`tool-${r}-${Date.now()}`};n.parent_tool_use_id&&(i.parent_tool_use_id=n.parent_tool_use_id,console.log(`ü§ñ [${r}] Subagent tool_use (parent: ${n.parent_tool_use_id.substring(0,20)}...): ${t.name}`)),e.emit(`message:${r}`,i)}if(i&&a.length>0){lastAssistantMessageIds.set(r,t),console.log(`üìù [${r}] Emitting assistant message ${t} with streaming=true`),console.log(`üìù [${r}] Content blocks: ${a.length} (types: ${a.map(e=>e.type).join(", ")})`);const s={type:"assistant",id:t,message:{...n.message,content:a},streaming:!0,timestamp:Date.now()};if(n.parent_tool_use_id&&(s.parent_tool_use_id=n.parent_tool_use_id,console.log(`ü§ñ [${r}] Subagent assistant message (parent: ${n.parent_tool_use_id.substring(0,20)}...)`)),e.emit(`message:${r}`,s),u.messages.push({type:"assistant",message:{content:a},id:t,timestamp:Date.now()}),u.messages.length>1e3){const e=Math.floor(200);u.messages.splice(0,e),console.log(`üßπ Trimmed ${e} old messages from session ${r}`)}_++}else if(c&&!i){lastAssistantMessageIds.set(r,t),allAssistantMessageIds.has(r)||allAssistantMessageIds.set(r,[]),allAssistantMessageIds.get(r).push(t),console.log(`üìù [${r}] Emitting assistant message ${t} (tool-only) with streaming=true`),e.emit(`message:${r}`,{type:"assistant",id:t,message:{...n.message,content:[]},streaming:!0,timestamp:Date.now()});const s=sessions.get(r);s&&s.messages.push({type:"assistant",message:{content:[]},id:t,timestamp:Date.now()}),_++}}}else if("user"===n.type&&n.message?.content){for(const t of n.message.content)if("tool_result"===t.type){if(o.has(t.tool_use_id)){console.log(`üîß [${r}] Bash tool result received, triggering focus restoration`);const n=o.get(t.tool_use_id);o.delete(t.tool_use_id),s&&(s=!1,console.log(`üîß [${r}] First bash command completed, focus restoration disabled for future commands`)),"win32"===process.platform&&e.emit(`trigger:focus:${n.sessionId}`,{timestamp:Date.now()})}let i=t.content;if("string"==typeof t.content&&(t.content.includes("has been updated")||t.content.includes("updated.")||t.content.includes("Applied")&&t.content.includes("edit")||t.content.includes("The file")||t.content.includes("snippet of the edited file"))){const e=t.content.match(/The file (.+?) has been updated/)||t.content.match(/Applied \d+ edits? to (.+?):/)||t.content.match(/file[:\s]+(.+?)(?:\s+has been|\s+updated|:|\n)/)||t.content.match(/\/[^\s]+\.(?:tsx?|jsx?|py|rs|md|css|json|yml|yaml|toml|html|vue|svelte)/g);if(e){const s=Array.isArray(e)&&!e[1]?e[0]:e[1]||e[0],o=join(u.workingDirectory||process.cwd(),s);console.log(`üìù [${r}] Attempting to enhance diff for: ${s}`);try{if(existsSync(o)){const e=readFileSync(o,"utf8").split("\n"),s=t.content.split("\n"),n=/(?:^\s*(\d+)[‚Üí:])|(?:line[s]?\s+(\d+))/i,a=new Set;if(s.forEach(e=>{const s=e.match(n);if(s){const e=s[1]||s[2];e&&a.add(parseInt(e))}}),a.size>0){console.log(`üìù [${r}] Found ${a.size} changed lines, enhancing with context`);const o=3,t=[],n=s.findIndex(e=>e.includes("Here's the result of running"));n>=0&&t.push(...s.slice(0,n+1));const c=Array.from(a).sort((e,s)=>e-s);let l=-999;c.forEach(s=>{const n=Math.max(1,s-o),i=Math.min(e.length,s+o);for(let o=n;o<s;o++)if(o>l){const s=String(o).padStart(6," ");a.has(o)?t.push(`${s}‚Üí${e[o-1]}`):t.push(`${s} ${e[o-1]}`),l=o}const r=String(s).padStart(6," ");s>l&&(t.push(`${r}‚Üí${e[s-1]}`),l=s);for(let o=s+1;o<=i;o++)if(o>l){const s=String(o).padStart(6," ");a.has(o)?t.push(`${s}‚Üí${e[o-1]}`):t.push(`${s} ${e[o-1]}`),l=o}const d=c[c.indexOf(s)+1];d&&d>i+1&&t.push("   ...")}),i=t.join("\n")}}}catch(e){console.log(`Could not enhance Edit output with context lines: ${e.message}`)}}}const a={type:"tool_result",message:{tool_use_id:t.tool_use_id,content:i,is_error:t.is_error},streaming:!0,timestamp:Date.now(),id:`toolresult-${r}-${Date.now()}`};n.parent_tool_use_id&&(a.parent_tool_use_id=n.parent_tool_use_id,console.log(`ü§ñ [${r}] Subagent tool_result (parent: ${n.parent_tool_use_id.substring(0,20)}...)`)),e.emit(`message:${r}`,a)}}else if("content_block_start"===n.type)console.log(`üìù [${r}] Content block starting:`,n.content_block?.type),e.emit(`message:${r}`,{type:"content_block_start",content_block:n.content_block,index:n.index,timestamp:Date.now()});else if("content_block_stop"===n.type)console.log(`üìù [${r}] Content block stopped:`,n.index),e.emit(`message:${r}`,{type:"content_block_stop",index:n.index,timestamp:Date.now()});else if("rate_limit"===n.type)console.log(`‚ö†Ô∏è [${r}] Rate limit:`,n.rate_limit),e.emit(`message:${r}`,{type:"rate_limit",rate_limit:n.rate_limit,timestamp:Date.now()});else if("progress"===n.type)console.log(`‚è≥ [${r}] Progress:`,n.progress),e.emit(`message:${r}`,{type:"progress",progress:n.progress,message:n.message,timestamp:Date.now()});else if("compact"===n.type||"system"===n.type&&"compact"===n.subtype)console.log(`üóúÔ∏è [${r}] Context compacted`),e.emit(`message:${r}`,{type:"system",subtype:"compact",message:{content:"context compressed - usage will reset on next message"},timestamp:Date.now()});else if("ping"===n.type||"pong"===n.type)console.log(`üèì [${r}] ${n.type} received`);else if("metadata"===n.type)console.log(`üìã [${r}] Metadata:`,n),n.title&&e.emit(`title:${r}`,n.title);else if("summary"===n.type)console.log(`üìù [${r}] Summary:`,n.summary),n.summary&&e.emit(`title:${r}`,n.summary);else if("result"===n.type){console.log(`üì¶ [${r}] RESULT: success=${!n.is_error}, duration=${n.duration_ms}ms`);const s=sessions.get(r),o=s?.messages?.filter(e=>"user"===e.role).pop(),t="/compact"===o?.message?.content?.trim(),i=!0===s?.isCompacting,a=t&&(n.result?.includes("Compacted")||n.result?.includes("compressed")||n.result?.includes("summary")||""===n.result||null===n.result);if(i){console.log(`üóúÔ∏è [${r}] Received compact summary from Claude`);let o=n.result;if(!o||""===o.trim()||o.includes("ready to continue")||o.includes("continue normally")||o.length<50){console.log("üóúÔ∏è Result is empty/generic, looking for last assistant message");const e=s?.messages?.filter(e=>"assistant"===e.type&&e.message?.content)||[];for(let s=e.length-1;s>=0;s--){const t=e[s],n=t.message?.content;let i="";if("string"==typeof n)i=n;else if(Array.isArray(n)){i=n.filter(e=>"text"===e.type&&e.text).map(e=>e.text).join("\n").trim()}if(i&&i.length>100){o=i,console.log(`üóúÔ∏è Using assistant message as summary (${i.length} chars)`);break}}(!o||o.length<50)&&(o="Conversation compacted successfully. Previous context preserved.",console.log("üóúÔ∏è Using fallback summary"))}console.log(`üóúÔ∏è Summary length: ${o.length} chars`),console.log(`üóúÔ∏è Previous token count: ${s.compactStartTokens}`),s.compactSummary=o;const t=void 0!==getWrapperSession?getWrapperSession(r):null;s.tokensSavedByCompact=s.compactStartTokens||t?.totalTokens||0;const i=s.claudeSessionId;s.claudeSessionId=null,s.wasCompacted=!0,s.isCompacting=!1,console.log(`üóúÔ∏è Saved summary and cleared session ${i}`),console.log("üóúÔ∏è Next message will start fresh with summary as context");let a=`‚úÖ Conversation compacted successfully!\n\nüìä Compaction Summary:\n‚Ä¢ Tokens saved: ${s.tokensSavedByCompact.toLocaleString()}\n‚Ä¢ Previous messages: ${s.compactMessageCount||s.messages.length}\n‚Ä¢ Summary preserved: Yes`;s.compactCustomInstructions&&(a+=`\n‚Ä¢ Custom focus: ${s.compactCustomInstructions}`),a+=`\n\nüìù Summary:\n${o}\n\n‚ú® Context has been compressed. You can continue normally.`;const c=activeProcessStartTimes.get(r),l=n.duration_ms||(c?Date.now()-c:0);console.log(`üóúÔ∏è Duration: jsonData.duration_ms=${n.duration_ms}, calculated=${c?Date.now()-c:"N/A"}, using=${l}ms`);const u={type:"result",subtype:"success",is_error:!1,result:a,session_id:null,duration_ms:n.duration_ms||l,usage:{input_tokens:0,output_tokens:0,cache_creation_input_tokens:0,cache_read_input_tokens:0},wrapperTokens:{input:0,output:0,total:0,cache_read:0,cache_creation:0},streaming:!1,id:`result-${r}-${Date.now()}-${Math.random()}`,model:n.model||d||"claude-sonnet-4-5-20250929",timestamp:Date.now()};return e.emit(`message:${r}`,u),console.log(`üì§ [${r}] Sent compact success message`),s.messages=[],void(s.compactCount=(s.compactCount||0)+1)}if(a&&!i){if(console.log(`üóúÔ∏è [${r}] Detected /compact command completion`),console.log(`üóúÔ∏è [${r}] Result text: "${n.result}"`),console.log(`üóúÔ∏è [${r}] Session ID in result: ${n.session_id}`),console.log(`üóúÔ∏è [${r}] Usage data:`,n.usage),s){const e=s.claudeSessionId;s.claudeSessionId=null,s.wasCompacted=!0,s.compactSummary=n.result||"conversation summarized",s.compactedTokenCount=compactedTokens?.total||0,s.tokensSavedByCompact=s.totalTokens||0,console.log(`üóúÔ∏è Cleared session ID (was ${e}) - next message will start fresh after compact`),console.log("üóúÔ∏è Marked session as compacted to prevent old ID restoration"),console.log(`üóúÔ∏è Stored compact summary for next session: ${s.compactSummary.substring(0,100)}...`),console.log("üóúÔ∏è The compact command has summarized the conversation - continuing with reduced context")}if(console.log(`üóúÔ∏è [${r}] Compact complete - tokens will reset on next message`),s){const e=s.totalTokens||0;s.totalTokens=0,s.inputTokens=0,s.outputTokens=0,console.log(`üóúÔ∏è [${r}] Reset session tokens from ${e} to 0`)}const o=getWrapperSession(r),t=o.accumulatedTotalTokens;o.accumulatedInputTokens=0,o.accumulatedOutputTokens=0,o.accumulatedTotalTokens=0,o.accumulatedCacheRead=0,o.accumulatedCacheCreation=0,o.inputTokens=0,o.outputTokens=0,o.totalTokens=0,console.log(`üóúÔ∏è [${r}] Reset wrapper accumulated tokens from ${t} to 0`),e.emit(`message:${r}`,{type:"system",subtype:"compact",session_id:null,message:{content:"context compacted - tokens reset",compactedTokens:{input:0,output:0,total:0,cache_read:0,cache_creation:0,reset:!0},tokensSaved:s?.tokensSavedByCompact||0,compactSummary:n.result||"conversation summarized"},timestamp:Date.now()})}if(n.usage){const e=n.usage.input_tokens||0,s=n.usage.output_tokens||0,o=n.usage.cache_creation_input_tokens||0,t=n.usage.cache_read_input_tokens||0,i=e+s,a=getWrapperSession(r).accumulatedTotalTokens;console.log("\nüìä TOKEN USAGE BREAKDOWN:"),console.log("   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"),console.log("   ‚îÇ Type            ‚îÇ Input    ‚îÇ Cache Read   ‚îÇ Cache New  ‚îÇ"),console.log("   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"),console.log(`   ‚îÇ User Message    ‚îÇ ${String(e).padEnd(8)} ‚îÇ              ‚îÇ            ‚îÇ`),console.log(`   ‚îÇ Assistant Reply ‚îÇ ${String(s).padEnd(8)} ‚îÇ              ‚îÇ            ‚îÇ`),console.log(`   ‚îÇ Context History ‚îÇ          ‚îÇ ${String(t).padEnd(12)} ‚îÇ            ‚îÇ`),console.log(`   ‚îÇ Cache Created   ‚îÇ          ‚îÇ              ‚îÇ ${String(o).padEnd(10)} ‚îÇ`),console.log("   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"),console.log(`   ‚îÇ New Tokens      ‚îÇ ${String(i).padEnd(8)} ‚îÇ (billing)    ‚îÇ (billing)  ‚îÇ`),console.log("   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"),console.log(`   ACCUMULATED CONTEXT: ${a} / 200000 (${(a/2e3).toFixed(1)}%)`),console.log("   Note: Accumulated across session. Cache values are for billing only.")}const c=lastAssistantMessageIds.get(r);c&&console.log(`üìã [${r}] Result received with last assistant message ${c} - deferring streaming=false to process exit`),console.log(`‚úÖ [${r}] Sending result message with model: ${d}`);const l={type:"result",...n,streaming:!1,id:`result-${r}-${Date.now()}`,model:d||"unknown"};if(n.usage){l.usage=n.usage;const e=getWrapperSession(r);l.wrapper={tokens:{input:e.accumulatedInputTokens,output:e.accumulatedOutputTokens,total:e.accumulatedTotalTokens,cache_read:e.accumulatedCacheRead,cache_creation:e.accumulatedCacheCreation,lastRequest:{input:n.usage.input_tokens||0,output:n.usage.output_tokens||0,total:(n.usage.input_tokens||0)+(n.usage.output_tokens||0),cache_read:n.usage.cache_read_input_tokens||0,cache_creation:n.usage.cache_creation_input_tokens||0}}},console.log("üìä [WRAPPER-TOKENS] Added both usage and wrapper tokens to result message:",{usage:l.usage,wrapperTokens:l.wrapper.tokens})}else console.log("‚ùå [WRAPPER-TOKENS] No usage data in jsonData, neither usage nor wrapper field added");if(!a&&s.claudeSessionId&&(l.session_id=s.claudeSessionId),console.log(`   - Model in result message: ${l.model}`),console.log(`   - Session ID in result message: ${l.session_id||"(cleared after compact)"}`),l.usage&&l.wrapper?.tokens){const e=l.wrapper.tokens.total,s=l.wrapper.tokens.lastRequest;console.log("   - Usage breakdown (this request):"),console.log(`     ‚Ä¢ input_tokens: ${s?.input||0}`),console.log(`     ‚Ä¢ output_tokens: ${s?.output||0}`),console.log(`     ‚Ä¢ cache_creation: ${s?.cache_creation||0} (billing only)`),console.log(`     ‚Ä¢ cache_read: ${s?.cache_read||0} (billing only)`),console.log(`     ‚Ä¢ ACCUMULATED CONTEXT: ${e} / 200000 (${(e/2e3).toFixed(1)}%)`)}console.log("üì§ [EMIT-DEBUG] About to emit result message with wrapper field:",{hasWrapper:!!l.wrapper,wrapperTokens:l.wrapper?.tokens,messageKeys:Object.keys(l),wrapperStructure:l.wrapper?Object.keys(l.wrapper):null}),e.emit(`message:${r}`,l),_++}}catch(e){console.log(`‚ö†Ô∏è [${r}] Failed to parse JSON, treating as plain text:`,e.message),console.log(`‚ö†Ô∏è [${r}] Line was: ${t}`)}}};console.log(`üîç [${r}] Process spawned with PID: ${T.pid}`),console.log(`üîç [${r}] Process connected: ${T.connected}`);let N="";T.stderr.on("data",e=>{const s=e.toString();N+=s,console.error(`‚ùå [${r}] STDERR output: ${s}`),(s.includes("command not found")||s.includes("No such file"))&&(console.error(`‚ùå [${r}] WSL PATH ERROR - Claude CLI not found!`),console.error(`‚ùå [${r}] Full stderr: ${N}`)),(s.includes("bash:")||s.includes("sh:"))&&console.error(`‚ùå [${r}] WSL BASH ERROR detected`)});const O=setInterval(()=>{if(E.length>0&&Date.now()-D>5e3&&(console.warn(`‚ö†Ô∏è [${r}] Flushing stale buffer (${E.length} chars)`),E.trim()))try{L(E),E=""}catch(e){console.log(`üìù [${r}] Buffer contains incomplete JSON, waiting for more data`)}},5e3);T.stdout.on("data",e=>{const s=e.toString();if(A+=e.length,D=Date.now(),j(),s.length>1e3&&console.log(`üì• [${r}] STDOUT: ${s.length} bytes (total: ${A})`),E.length>52428800){if(console.error(`‚ö†Ô∏è [${r}] Line buffer overflow (${E.length} bytes), processing and clearing`),E.includes("{")){const e=E.match(/\{[^}]*\}/g);if(e)for(const s of e)try{L(s)}catch(e){console.error(`[${r}] Failed to process JSON chunk:`,e)}}E=""}E+=s;const o=E.split("\n");E=o.pop()||"";for(let e=0;e<o.length;e++)L(o[e])}),T.on("exit",()=>{clearInterval(O)}),T.stderr.on("data",s=>{const o=s.toString();if(console.error(`‚ö†Ô∏è [${r}] Claude stderr (${s.length} bytes):`,o),D=Date.now(),o.includes("No conversation found with session ID"))return console.log(`üîÑ [${r}] Resume failed (stderr) - already handled in stdout`),void(u?.wasCompacted&&console.log("üîÑ This was expected - session was compacted and old ID is no longer valid"));(o.includes("Error:")||o.includes("error:"))&&e.emit(`message:${r}`,{type:"error",error:o,claudeSessionId:u.claudeSessionId,streaming:!1})}),T.on("close",s=>{if(T.stdin&&!T.stdin.destroyed)try{T.stdin.end(),console.log("üìù Closed stdin on process exit")}catch(e){}if(b.timer&&(clearTimeout(b.timer),b.timer=null,console.log("üêï Watchdog timer cleared on process exit")),P)try{const e=require("fs");e.existsSync(P)&&(e.unlinkSync(P),console.log(`üßπ Cleaned up Windows temp file: ${P}`))}catch(e){console.warn(`‚ö†Ô∏è Failed to clean up temp file: ${e.message}`)}streamHealthChecks.has(r)&&(clearInterval(streamHealthChecks.get(r)),streamHealthChecks.delete(r)),streamTimeouts.has(r)&&(clearTimeout(streamTimeouts.get(r)),streamTimeouts.delete(r)),clearInterval(x);const o=Date.now()-v;if(console.log(`üëã [${r}] Claude process exited with code ${s}`),console.log(`üìä [${r}] STREAM SUMMARY:`),console.log(`   ‚îú‚îÄ Total duration: ${o}ms`),console.log(`   ‚îú‚îÄ Total bytes: ${A}`),console.log(`   ‚îú‚îÄ Messages: ${_}`),console.log(`   ‚îú‚îÄ Exit code: ${s}`),console.log(`   ‚îú‚îÄ Stderr: ${N||"(empty)"}`),console.log(`   ‚îî‚îÄ Line buffer: ${E||"(empty)"}`),0===A&&(console.error(`‚ùå [${r}] NO OUTPUT RECEIVED FROM CLAUDE!`),console.error(`‚ùå [${r}] This usually means:`),console.error("   1. Claude CLI is not installed in WSL"),console.error("   2. Claude is not in any of the expected paths"),console.error("   3. WSL is not running properly"),console.error("   4. The command syntax is wrong")),activeProcesses.delete(r),activeProcessStartTimes.delete(r),T&&T.pid&&killedProcessPIDs.delete(T.pid),0===s){const e=sessions.get(r);e&&(e.wasInterrupted=!1,console.log(`‚úÖ Marked session ${r} as completed normally`))}else if(1===s){const e=sessions.get(r);e&&e.claudeSessionId&&N.includes("No conversation found")&&(console.log(`‚ö†Ô∏è [${r}] Resume failed detected on exit (exit code 1)`),e.claudeSessionId=null,e.isReady=!0)}if(E.trim())try{L(E)}catch(e){console.error("Failed to process remaining buffer:",e)}const t=sessions.get(r);if(t?.wasInterrupted)console.log("üîÑ Skipping streaming=false for interrupted process (new process is running)");else{const s=lastAssistantMessageIds.get(r);cancelPendingStreamingFalse(r),console.log(`‚è±Ô∏è [${r}] Scheduling streaming=false with 600ms debounce`);const o=setTimeout(()=>{if(activeProcesses.has(r))return console.log(`üîÑ [${r}] New process started during debounce - skipping streaming=false`),void pendingStreamingFalseTimers.delete(r);const o=sessions.get(r);if(o?.wasInterrupted)return console.log(`üîÑ [${r}] Session interrupted during debounce - skipping streaming=false`),void pendingStreamingFalseTimers.delete(r);if(s){console.log(`üî¥ [${r}] Debounce complete - marking streaming=false for ${s}`);const t=o?.messages.find(e=>e.id===s);e.emit(`message:${r}`,{type:"assistant",id:s,message:t?.message||{content:""},streaming:!1,timestamp:Date.now()}),lastAssistantMessageIds.delete(r)}e.emit(`message:${r}`,{type:"system",subtype:"stream_end",streaming:!1,timestamp:Date.now()}),pendingStreamingFalseTimers.delete(r)},600);pendingStreamingFalseTimers.set(r,{timer:o,timestamp:Date.now()})}null===s||-2===s||"SIGKILL"===s?(console.error(`‚ö†Ô∏è Claude process terminated unexpectedly (code: ${s})`),e.emit(`message:${r}`,{type:"error",error:"session terminated unexpectedly. you can resume by sending another message.",streaming:!1,timestamp:Date.now()})):0!==s&&(t.wasInterrupted?(console.log(`Process exited with code ${s} after interruption - not showing error`),t.wasInterrupted=!1):(console.error(`Claude process failed with exit code ${s}`),e.emit(`message:${r}`,{type:"system",subtype:"info",message:`process completed with code ${s}`,timestamp:Date.now()})))}),T.on("error",s=>{if(P)try{const e=require("fs");e.existsSync(P)&&(e.unlinkSync(P),console.log(`üßπ Cleaned up Windows temp file on error: ${P}`))}catch(e){console.warn(`‚ö†Ô∏è Failed to clean up temp file: ${e.message}`)}streamHealthChecks.has(r)&&(clearInterval(streamHealthChecks.get(r)),streamHealthChecks.delete(r)),streamTimeouts.has(r)&&(clearTimeout(streamTimeouts.get(r)),streamTimeouts.delete(r)),clearInterval(x),console.error(`‚ùå [${r}] Failed to spawn claude:`,s),console.error(`‚ùå [${r}] Error details:`,{message:s.message,code:s.code,syscall:s.syscall,path:s.path}),cancelPendingStreamingFalse(r);const o=lastAssistantMessageIds.get(r);if(o){console.log(`üî¥ Forcing streaming=false for assistant message ${o} on process error`);const s=sessions.get(r),t=s?.messages.find(e=>e.id===o);e.emit(`message:${r}`,{type:"assistant",id:o,message:t?.message||{content:""},streaming:!1,timestamp:Date.now()}),lastAssistantMessageIds.delete(r)}e.emit(`message:${r}`,{type:"error",error:`claude process error: ${s.message}. try sending your message again.`,claudeSessionId:u.claudeSessionId,streaming:!1}),activeProcesses.delete(r),activeProcessStartTimes.delete(r),lastAssistantMessageIds.delete(r),i&&i({success:!1,error:s.message})}),i&&i({success:!0})}catch(s){console.error("‚ùå Error in spawnRequest:",s),e.emit(`message:${r}`,{type:"error",error:s.message,claudeSessionId:u.claudeSessionId,streaming:!1}),i&&i({success:!1,error:s.message})}finally{t()}};processSpawnQueue.push(g),console.log(`üìã Added request to queue. Queue length: ${processSpawnQueue.length}`),1===processSpawnQueue.length&&t()}),e.on("interrupt",({sessionId:s},o)=>{const t=activeProcesses.get(s),n=activeBashProcesses.get(s),i=sessions.get(s),r="win32"===process.platform;console.log(`‚õî Interrupt requested for session ${s}`);const a=e=>{if(e)try{require("child_process").execSync(`taskkill /F /T /PID ${e}`,{stdio:"ignore",timeout:5e3}),console.log(`üõë Force killed process tree for PID ${e} using taskkill`)}catch(s){console.log(`‚ö†Ô∏è taskkill failed for PID ${e}: ${s.message}`)}},c=processSpawnQueue.length;c>0&&(processSpawnQueue.length=0,console.log(`üßπ Cleared ${c} queued messages after interrupt`));const l=spawningProcesses.get(s);if(l&&!l.aborted)return console.log(`‚ö†Ô∏è Session ${s} is currently spawning - marking for abort`),l.aborted=!0,spawningProcesses.set(s,l),o&&(pendingInterrupts.set(s,o),console.log(`üìù Stored pending interrupt callback for session ${s}`)),void e.emit(`message:${s}`,{type:"system",subtype:"interrupted",message:"stopping task...",timestamp:Date.now()});if(n){console.log(`üõë Killing bash process for session ${s} (PID: ${n.pid})`);try{if(r){a(n.pid);try{n.kill()}catch(e){}}else if(n.pid)try{process.kill(-n.pid,"SIGTERM")}catch(e){n.kill("SIGTERM")}else n.kill("SIGTERM");activeBashProcesses.delete(s),e.emit(`message:${s}`,{type:"system",subtype:"interrupted",message:"bash command interrupted by user",timestamp:Date.now()}),o&&o({success:!0})}catch(e){console.error(`‚ùå Error killing bash process: ${e.message}`),o&&o({success:!1,error:e.message})}}else if(t){if(console.log(`üõë Killing claude process for session ${s} (PID: ${t.pid})`),r){a(t.pid);try{t.kill()}catch(e){}}else if(t.pid)try{process.kill(-t.pid,"SIGINT")}catch(e){t.kill("SIGINT")}else t.kill("SIGINT");activeProcesses.delete(s),activeProcessStartTimes.delete(s),stoppedSessions.set(s,!0),i&&(i.wasInterrupted=!1,i.claudeSessionId=null,i.interruptedSessionId=null,console.log(`üõë Session ${s} stopped by user - cleared session state to prevent auto-resume`));const n=lastAssistantMessageIds.get(s);n&&(e.emit(`message:${s}`,{type:"assistant",id:n,streaming:!1,timestamp:Date.now()}),lastAssistantMessageIds.delete(s)),e.emit(`message:${s}`,{type:"system",subtype:"interrupted",message:"task interrupted by user",timestamp:Date.now()}),o&&o({success:!0})}else console.log(`‚ö†Ô∏è No active process found for session ${s} - nothing to interrupt`),spawningProcesses.delete(s),pendingInterrupts.delete(s),e.emit(`message:${s}`,{type:"system",subtype:"interrupted",message:"task stopped",timestamp:Date.now()}),o&&o({success:!0,noProcess:!0})}),e.on("clearSession",({sessionId:s})=>{const o=sessions.get(s);if(!o)return void console.error(`Session not found: ${s}`);const t=activeProcesses.get(s);if(t){console.log(`üõë Killing process for cleared session ${s} (PID: ${t.pid})`);if("win32"===process.platform&&t.pid){try{require("child_process").execSync(`taskkill /F /T /PID ${t.pid}`,{stdio:"ignore",timeout:5e3})}catch(e){console.log(`‚ö†Ô∏è taskkill failed: ${e.message}`)}try{t.kill()}catch(e){}}else if(t.pid)try{process.kill(-t.pid,"SIGINT")}catch(e){t.kill("SIGINT")}else t.kill("SIGINT");activeProcesses.delete(s),activeProcessStartTimes.delete(s)}o.messages=[],o.claudeSessionId=null,o.hasGeneratedTitle=!1,o.wasInterrupted=!1,o.wasCompacted=!1,lastAssistantMessageIds.delete(s),stoppedSessions.delete(s),console.log(`‚úÖ Session ${s} cleared - will start fresh Claude session on next message`),e.emit(`message:${s}`,{type:"system",subtype:"clear",message:"session cleared",timestamp:Date.now()});const n=`title:${s}`;console.log(`üè∑Ô∏è Emitting title reset for cleared session: ${n}`),e.emit(n,{title:"new session"})}),e.on("deleteSession",async(e,s)=>{const{sessionId:o}=e;sessions.delete(o),lastAssistantMessageIds.delete(o),stoppedSessions.delete(o),cancelPendingStreamingFalse(o),spawningProcesses.delete(o),s({success:!0})});const n=new Map,i=new Map;e.on("create-checkpoint",async s=>{const{sessionId:o,description:t,trigger:r="manual"}=s;console.log(`üì∏ Creating checkpoint for session ${o}`);try{const s=sessions.get(o);if(!s)return void e.emit("checkpoint-error",{sessionId:o,error:"Session not found"});const a=`chk_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,c={id:a,sessionId:o,projectPath:s.projectPath||process.cwd(),parentId:i.get(o)?.currentCheckpoint,createdAt:(new Date).toISOString(),messageCount:s.messages?s.messages.length:0,metadata:{description:t,trigger:r,tokensUsed:s.tokenCount||0,model:s.model||"opus",messageIds:s.messages?s.messages.map(e=>e.id):[]},fileSnapshots:[]};if(n.has(o)||n.set(o,[]),n.get(o).push(c),i.has(o)){const e=i.get(o);e.currentCheckpoint=a,e.checkpoints.set(a,c)}else i.set(o,{sessionId:o,rootCheckpoint:a,currentCheckpoint:a,checkpoints:new Map,branches:[]});const l="win32"===process.platform?process.env.USERPROFILE||process.env.HOMEDRIVE+process.env.HOMEPATH:process.env.HOME||homedir(),d=path.join(l,".yurucode","checkpoints",o);fs.existsSync(d)||fs.mkdirSync(d,{recursive:!0});const u=path.join(d,`${a}.json`);fs.writeFileSync(u,JSON.stringify(c,null,2)),console.log(`‚úÖ Checkpoint created: ${a}`),e.emit("checkpoint-created",{sessionId:o,checkpoint:c})}catch(s){console.error("‚ùå Checkpoint creation failed:",s),e.emit("checkpoint-error",{sessionId:o,error:s.message})}}),e.on("restore-checkpoint",async s=>{const{sessionId:o,checkpointId:t}=s;console.log(`‚èÆÔ∏è Restoring checkpoint ${t} for session ${o}`);try{const s=n.get(o);if(!s)throw new Error("No checkpoints found for session");const r=s.find(e=>e.id===t);if(!r)throw new Error("Checkpoint not found");const a=sessions.get(o);if(!a)throw new Error("Session not found");const c=a.messages.filter(e=>r.metadata.messageIds.includes(e.id));a.messages=c,a.tokenCount=r.metadata.tokensUsed;const l=i.get(o);l&&(l.currentCheckpoint=t),console.log(`‚úÖ Checkpoint restored: ${t}`),e.emit("checkpoint-restored",{sessionId:o,checkpointId:t,messages:c})}catch(s){console.error("‚ùå Checkpoint restoration failed:",s),e.emit("checkpoint-error",{sessionId:o,error:s.message})}}),e.on("get-timeline",async s=>{const{sessionId:o}=s,t=i.get(o),r=n.get(o)||[];e.emit("timeline-data",{sessionId:o,timeline:t||null,checkpoints:r})});const r=new Map,a=new Map;e.on("execute-agent",async s=>{const{sessionId:o,agentConfig:t,projectPath:n=process.cwd()}=s;console.log(`ü§ñ Executing agent for session ${o}`);const i=`run_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{const s={id:i,sessionId:o,status:"starting",config:t,projectPath:n,startTime:(new Date).toISOString(),endTime:null,output:[],metrics:{messagesProcessed:0,tokensUsed:0,toolsExecuted:0,errors:0}};r.set(i,s);const c=["--output-format","stream-json","--verbose","--print"];t.model&&c.push("--model",t.model);let l=t.systemPrompt||"";t.task&&(l=`${l}\n\nTask: ${t.task}`);const d=[...c];console.log(`üöÄ Spawning agent process: claude ${d.join(" ")}`);const u="win32"===process.platform,g=("linux"===process.platform&&fs.existsSync("/mnt/c"),u?claudePath.endsWith(".cmd")?claudePath:`${claudePath}.cmd`:claudePath),m=spawn(g,d,{cwd:n,env:{...process.env},shell:u});a.set(i,m),s.status="running",l&&m.stdin.write(l+"\n");let p="";m.stdout.on("data",t=>{p+=t.toString();const n=p.split("\n");p=n.pop()||"";for(const t of n)if(t.trim())try{const n=JSON.parse(t);s.metrics.messagesProcessed++,"tool_use"===n.type&&s.metrics.toolsExecuted++,"result"===n.type&&n.usage&&(s.metrics.tokensUsed+=n.usage.output_tokens||0),s.output.push({timestamp:(new Date).toISOString(),data:n}),e.emit("agent-progress",{runId:i,sessionId:o,data:n,metrics:s.metrics})}catch(e){console.error("Failed to parse agent output:",e),s.metrics.errors++}}),m.stderr.on("data",t=>{const n=t.toString();console.error(`‚ùå Agent error: ${n}`),s.metrics.errors++,e.emit("agent-error",{runId:i,sessionId:o,error:n})}),m.on("close",n=>{if(console.log(`‚úÖ Agent completed with code ${n}`),s.status=0===n?"completed":"failed",s.endTime=(new Date).toISOString(),a.delete(i),e.emit("agent-completed",{runId:i,sessionId:o,status:s.status,metrics:s.metrics}),t.createCheckpoint){const s={sessionId:o,description:`Agent run: ${t.name||i}`,trigger:"auto"};e.emit("create-checkpoint",s)}}),e.emit("agent-started",{runId:i,sessionId:o,config:t})}catch(s){console.error("‚ùå Agent execution failed:",s),e.emit("agent-error",{runId:i,sessionId:o,error:s.message})}}),e.on("stop-agent",async s=>{const{runId:o}=s;console.log(`‚èπÔ∏è Stopping agent ${o}`);const t=a.get(o);if(t){t.kill("SIGINT"),a.delete(o);const s=r.get(o);s&&(s.status="stopped",s.endTime=(new Date).toISOString()),e.emit("agent-stopped",{runId:o})}else e.emit("agent-error",{runId:o,error:"Agent not found or already stopped"})}),e.on("get-agent-runs",async s=>{const{sessionId:o}=s,t=Array.from(r.values()).filter(e=>e.sessionId===o);e.emit("agent-runs-data",{sessionId:o,runs:t})}),e.on("disconnect",()=>{console.log("üîå Client disconnected:",e.id);for(const[s,o]of sessions.entries())if(o.socketId===e.id){streamHealthChecks.has(s)&&(clearInterval(streamHealthChecks.get(s)),streamHealthChecks.delete(s)),streamTimeouts.has(s)&&(clearTimeout(streamTimeouts.get(s)),streamTimeouts.delete(s));const e=activeProcesses.get(s);if(e){console.log(`üßπ Cleaning up process for session ${s} (PID: ${e.pid})`);if("win32"===process.platform&&e.pid){try{require("child_process").execSync(`taskkill /F /T /PID ${e.pid}`,{stdio:"ignore",timeout:5e3})}catch(e){}try{e.kill()}catch(e){}}else if(e.pid)try{process.kill(-e.pid,"SIGINT")}catch(s){e.kill("SIGINT")}else e.kill("SIGINT");activeProcesses.delete(s),activeProcessStartTimes.delete(s)}lastAssistantMessageIds.delete(s),cancelPendingStreamingFalse(s),spawningProcesses.delete(s)}})}),cleanupOldPidFiles(),httpServer.listen(PORT,()=>{writePidFile(),console.log(`üöÄ yurucode server running on port ${PORT}`),console.log(`üìÇ Working directory: ${process.cwd()}`),console.log(`üñ•Ô∏è Platform: ${platform()}`),console.log(`üè† Home directory: ${homedir()}`),console.log(`üìÅ Claude projects: ${join(homedir(),".claude","projects")}`);const e=join(homedir(),".claude","projects");if(existsSync(e)){console.log("‚úÖ Claude projects directory exists");try{const{readdirSync:s}=require("fs"),o=s(e);console.log(`üìä Found ${o.length} project directory(s)`),o.length>0&&"win32"===platform()&&(console.log("üîç Sample project paths (first 3):"),o.slice(0,3).forEach(e=>{if(console.log(`  - ${e}`),e.match(/^[A-Z]--/)){const s=e.replace(/^([A-Z])--/,"$1:/").replace(/-/g,"/");console.log(`    ‚Üí Would convert to: ${s}`)}}))}catch(e){console.log("‚ö†Ô∏è Could not list projects:",e.message)}}else console.log("‚ö†Ô∏è Claude projects directory not found at:",e);console.log(`‚úÖ Server configured for ${"win32"===platform()?"Windows":platform()}`),console.log("‚úÖ Server ready for bash commands")}),httpServer.on("error",e=>{if("EADDRINUSE"===e.code){console.error(`‚ùå Port ${PORT} is already in use`),console.log("Attempting to kill existing process and retry...");const{exec:e}=require("child_process");e(`lsof -ti :${PORT} | xargs kill -9`,e=>{e?(console.error("Failed to kill existing process. Please restart the app."),process.exit(1)):(console.log("Killed existing process, retrying in 1 second..."),setTimeout(()=>{httpServer.listen(PORT)},1e3))})}else console.error("Server error:",e),process.exit(1)});